<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trải Bài Tarot Cùng AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <style>
        :root {
            --bg-color: #0c0a09;
            --text-color: #e2e0dd;
            --title-color: #d4af37;
            --card-back-bg: #1e1b18;
            --card-back-border: #443c2d;
            --button-bg: #292524;
            --button-hover-bg: #44403c;
            --font-title: 'Playfair Display', serif;
            --font-body: 'Quicksand', sans-serif;
        }

        /* --- Cài đặt chung --- */
        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden; /* Ngăn cuộn ngang */
        }
        
        /* --- NÚT LỊCH SỬ --- */
        #history-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1500;
            background-color: var(--button-bg);
            border: 1px solid var(--card-back-border);
            color: var(--title-color);
            font-family: var(--font-body);
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }
        #history-btn:hover {
            background-color: var(--button-hover-bg);
        }

        /* --- (CHỈNH SỬA) MODAL LỊCH SỬ --- */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
        }
        .modal-content {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2001;
            background-color: var(--card-back-bg);
            border: 1px solid var(--card-back-border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            color: var(--text-color);
            /* (THAY ĐỔI) Tách layout bằng flex để sửa lỗi scrollbar */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Ẩn overflow ở đây */
            padding: 0; /* Xóa padding ở đây */
        }
        
        /* (MỚI) Header của Modal */
        .modal-header {
            position: relative;
            padding: 1.5rem 1.5rem 0 1.5rem;
            flex-shrink: 0; /* Không co lại */
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem; /* Điều chỉnh vị trí */
            right: 1rem; /* Điều chỉnh vị trí */
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
        }
        .modal-close-btn:hover { opacity: 1; }
        .modal-content h2 {
            font-family: var(--font-title);
            color: var(--title-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        /* (MỚI) Wrapper cuộn nội dung */
        .modal-scroll-wrapper {
            overflow-y: auto; /* Đặt thanh cuộn ở đây */
            padding: 0 1.5rem 1.5rem 1.5rem;
            flex-grow: 1;
        }

        #history-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .history-item {
            border-bottom: 1px solid var(--card-back-border);
            padding-bottom: 1.5rem;
            text-align: left; /* (MỚI) Căn lề trái cho nội dung */
        }
        .history-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .history-item h3 {
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0 0 0.5rem 0;
        }
        .history-item .history-date {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 1rem;
        }
        .history-cards-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            justify-content: center; /* (MỚI) Căn giữa các lá bài */
        }
        .history-card-item {
            width: 80px;
            flex-shrink: 0;
            text-align: center;
        }
        .history-card-item img {
            width: 100%;
            border-radius: 5px;
        }
        .history-card-item img.reversed {
            transform: rotate(180deg);
        }
        .history-card-item .card-name {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            word-wrap: break-word;
        }
        .history-card-item .card-orientation {
            font-size: 0.7rem;
            color: var(--title-color);
            opacity: 0.9;
        }

        /* (MỚI) Nút chia sẻ trong lịch sử */
        .history-share-btn {
            display: inline-block;
            background-color: var(--button-bg);
            border: 1px solid var(--card-back-border);
            color: var(--title-color);
            padding: 0.5rem 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .history-share-btn:hover {
            background-color: var(--button-hover-bg);
        }
        .history-share-btn.success {
            background-color: #22c55e; /* Màu xanh lá */
            border-color: #16a34a;
            color: var(--bg-color);
        }
         .history-share-btn.error {
            background-color: #ef4444; /* Màu đỏ */
            border-color: #dc2626;
            color: var(--bg-color);
        }


        /* --- Quản lý các màn hình --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            width: 100%;
            position: relative;
        }
        .screen.active {
            display: flex;
        }
        
        /* --- Tiêu đề câu hỏi --- */
        .question-display-header {
            font-family: var(--font-title);
            color: var(--title-color);
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 1rem;
            padding: 0 1rem;
            position: absolute;
            top: 3rem; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            line-height: 1.3;
        }

        /* --- Màn hình 1: Đặt câu hỏi --- */
        #question-screen .title {
            font-family: var(--font-title);
            color: var(--title-color);
            font-size: clamp(2rem, 6vw, 3.5rem);
            letter-spacing: 2px;
            margin-bottom: 2rem;
        }

        .question-input-area {
            width: 100%;
            max-width: 600px;
            background-color: var(--button-bg);
            border-radius: 12px;
            padding: 8px;
            border: 1px solid var(--card-back-border);
        }

        .question-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 12px;
            resize: none;
            min-height: 80px;
        }
        .question-input:focus { outline: none; }

        .suggested-questions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin: 1.5rem 0;
        }

        .suggested-questions button {
            background-color: var(--button-bg);
            border: 1px solid var(--card-back-border);
            color: var(--text-color);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: var(--font-body);
            font-size: 0.9rem;
            height: 100%;
        }

        .suggested-questions button:hover {
            background-color: var(--button-hover-bg);
        }
        
        #submit-question-btn {
            background: none;
            border: none;
            color: var(--title-color);
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            text-decoration: underline;
        }
        
        /* --- Màn hình 2: Xáo bài --- */
        #shuffling-screen {
            justify-content: center;
        }

        .shuffling-animation-container {
            position: relative;
            width: 100px;
            height: 150px;
            margin-top: 10rem; 
        }

        .shuffle-card {
            position: absolute;
            width: 100px;
            height: 150px;
            background-color: var(--card-back-bg);
            border: 1px solid var(--card-back-border);
            border-radius: 8px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='80' height='80'%3E%3Cpath d='M40 20C40 20 40 40 40 40C40 40 40 60 40 60C40 60 40 40 40 40M20 40C20 40 40 40 40 40C40 40 60 40 60 40C60 40 40 40 40 40' stroke='%23d4af37' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='40' cy='40' r='10' stroke='%23d4af37' stroke-width='2' fill='none'/%3E%3C/svg%3E");
            background-size: 40%;
            background-repeat: no-repeat;
            background-position: center;
            animation: shuffle 1.5s ease-in-out infinite;
        }

        .shuffle-card:nth-child(1) { animation-delay: 0s; }
        .shuffle-card:nth-child(2) { animation-delay: -0.5s; }
        .shuffle-card:nth-child(3) { animation-delay: -1s; }
        
        @keyframes shuffle {
            0%, 100% { transform: translateX(-30px) rotate(-5deg); z-index: 1;}
            50% { transform: translateX(30px) rotate(5deg); z-index: 3;}
        }


        /* --- Màn hình 3: Chọn bài --- */
        #drawing-screen {
            justify-content: flex-start; 
            padding-top: 12rem; 
            padding-bottom: 3rem; 
            height: auto; 
            min-height: 100vh; 
        }

        .drawing-subheader {
            font-family: var(--font-body);
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2rem; 
            font-size: 1.2rem;
            transition: opacity 0.5s ease, transform 0.5s ease, height 0.5s ease, margin 0.5s ease;
        }

        #chosen-cards-display {
            display: flex;
            gap: 1.5rem;
            height: 250px;
            align-items: flex-start;
            justify-content: center;
            margin-bottom: 2.5rem; 
            transition: all 0.8s ease;
        }
        
        .chosen-card-placeholder {
            width: 120px;
            height: 180px;
            border: 2px dashed var(--card-back-border);
            border-radius: 10px;
            transition: all 1s ease;
        }

        .chosen-card-item {
            text-align: center;
            width: 120px; 
            transition: width 1s ease-in-out; 
        }
        @keyframes revealCard {
            to { opacity: 1; transform: translateY(0); }
        }

        .chosen-card-item img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: width 1s ease-in-out;
        }
 
        .chosen-card-item img.reversed { 
            transform: rotate(180deg)!important; 
        }
        
        .chosen-card-item .card-info { 
            margin-top: 0.75rem; 
            word-wrap: break-word; 
        }
        .chosen-card-item .card-name { font-weight: 600; }
        .chosen-card-item .card-orientation { font-size: 0.8rem; color: var(--title-color); }
        
        /* --- CSS Cho Hiệu Ứng Bay Của Lá Bài --- */
        .flying-card-animator {
            position: absolute; 
            z-index: 1000;
            transition: all 1s ease-in-out;
            transform-style: preserve-3d;
        }

        .flying-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1s ease-in-out;
            transform: translateZ(0); 
        }

        .flying-card-back,
        .flying-card-front {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            border-radius: 5px;
            overflow: hidden;
        }

        .flying-card-back {
            background-color: var(--card-back-bg);
            border: 1px solid var(--card-back-border);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='80' height='80'%3E%3Cpath d='M40 20C40 20 40 40 40 40C40 40 40 60 40 60C40 60 40 40 40 40M20 40C20 40 40 40 40 40C40 40 60 40 60 40C60 40 40 40 40 40' stroke='%23d4af37' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='40' cy='40' r='10' stroke='%23d4af37' stroke-width='2' fill='none'/%3E%3C/svg%3E");
            background-size: 40%;
            background-repeat: no-repeat;
            background-position: center;
            transform: translateZ(0); 
        }

        .flying-card-front {
            background-color: var(--card-back-bg); 
            transform: rotateY(180deg) translateZ(0); 
        }
        .flying-card-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .flying-card-front img.reversed {
            transform: rotate(180deg);
        }
        
        /* --- Bộ bài --- */
        #card-spread-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2.5rem; 
            transition: opacity 0.5s ease, transform 0.5s ease, height 0.5s ease, margin 0.5s ease;
        }
        .card-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0 10%; 
        }
         .facedown-card {
            flex-shrink: 0;
            width: 80px;
            aspect-ratio: 2/3;
            background-color: var(--card-back-bg);
            border: 1px solid var(--card-back-border);
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, opacity 0.3s ease;
            margin-left: -55px;
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='80' height='80'%3E%3Cpath d='M40 20C40 20 40 40 40 40C40 40 40 60 40 60C40 60 40 40 40 40M20 40C20 40 40 40 40 40C40 40 60 40 60 40C60 40 40 40 40 40' stroke='%23d4af37' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='40' cy='40' r='10' stroke='%23d4af37' stroke-width='2' fill='none'/%3E%3C/svg%3E");
            background-size: 40%;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transform: translateY(30px) scale(0.8) translateZ(0); 
        }
        .facedown-card:first-child { margin-left: 0; }

        .facedown-card.is-dealt {
            opacity: 1;
            transform: translateY(0) scale(1) translateZ(0);
        }

        @media (min-width: 768px){
                .facedown-card:hover {
                transform: translateY(-15px)!important; 
                border-color: var(--title-color);
            }
        }

        .facedown-card.is-chosen {
            opacity: 0!important; 
            pointer-events: none;
        }
        
        @keyframes dealCardIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1) translateZ(0);
            }
        }
        
        .mobile-row {
            display: none;
        }

        /* --- Nút CTA và Kết quả --- */
        #action-button-container {
            height: 60px;
            margin-top: 1rem;
        }

        .action-button {
            display: none;
            background-color: var(--title-color);
            color: var(--bg-color);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.8s ease, transform 0.8s ease;
            transform: scale(0.9);
            opacity: 0;
        }

        .action-button.visible {
            display: inline-block;
            transform: scale(1);
            opacity: 1;
        }

        /* Nơi hiển thị kết quả */
        #interpretation-results-display {
            display: none;
            background-color: var(--button-bg);
            padding: 2rem;
            border-radius: 8px;
            text-align: left;
            line-height: 1.8;
            max-width: 800px;
            width: 100%;
            margin: 2rem 0;
        }
        #interpretation-results-display h1, 
        #interpretation-results-display h2, 
        #interpretation-results-display h3 {
            font-family: var(--font-title);
            color: var(--title-color);
        }

        /* CSS cho trạng thái xem kết quả */
        #drawing-screen.results-active .drawing-subheader {
            opacity: 0;
            transform: translateY(-20px);
            height: 0; 
            margin-bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }
        #drawing-screen.results-active #card-spread-container {
            opacity: 0;
            transform: translateY(30px);
            pointer-events: none;
            height: 0; 
            margin-bottom: 0;
            overflow: hidden;
        }
        
        #drawing-screen.results-active #chosen-cards-display {
            height: auto; 
            margin-bottom: 1.5rem; 
        }
        
        #drawing-screen.results-active .chosen-card-placeholder {
            width: 0;
            height: 0;
            border: none;
            margin: 0;
            padding: 0;
            opacity: 0;
        }
        
        #drawing-screen.results-active .chosen-card-item {
            width: 150px; 
            animation: none; 
            opacity: 1; 
            transform: none; 
        }
        #drawing-screen.results-active .chosen-card-item img {
            width: 100%;
            animation: none; 
        }

        /* --- CSS CHO KHU VỰC HỎI TIẾP --- */
        #follow-up-question-container {
            display: none;
            width: 100%;
            max-width: 600px;
            margin-top: 2.5rem;
            text-align: center;
        }
        #follow-up-question-container h3 {
            font-family: var(--font-title);
            color: var(--title-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        #submit-follow-up-btn {
            display: inline-block;
            opacity: 1;
            transform: scale(1);
            margin-top: 1rem;
        }

        /* =================================== */
        /* === MEDIA QUERY FOR MOBILE ======== */
        /* =================================== */
        @media (max-width: 768px) {
            .facedown-card {
                width: 50px;
                margin-left: -35px;
            }
            
            #card-row-1, #card-row-2 {
                display: none;
            }
            .mobile-row {
                display: flex;
            }
            
            #chosen-cards-display {
                margin-bottom: 2rem;
                width: 100%; 
                transform: none; 
                gap: 0.5rem; 
                padding: 0 0.5rem; 
            }

            .chosen-card-item, .chosen-card-placeholder {
                width: 100px; 
                flex-shrink: 0; 
            }
            
            .chosen-card-placeholder {
                height: 150px; 
            }
            
            .chosen-card-item:not(:first-child),
            .chosen-card-placeholder:not(:first-child) {
                margin-left: 0; 
            }

            #drawing-screen.results-active #chosen-cards-display {
                width: 100%; 
                transform: none; 
                margin-bottom: 2rem;
                gap: 0.5rem; 
            }
            #drawing-screen.results-active .chosen-card-item {
                width: 100px; 
            }
            #drawing-screen.results-active .chosen-card-item:not(:first-child) {
                margin-left: 0; 
            }
            
            #drawing-screen.results-active .chosen-card-item .card-info {
                width: 100px; 
            }
            
            #history-btn {
                top: 0.75rem;
                right: 0.75rem;
                padding: 0.35rem 0.6rem;
                font-size: 0.8rem;
            }
        }

    </style>
</head>
<body>

    <!-- Nút Lịch sử -->
    <button id="history-btn">Lịch sử</button>

    <!-- Màn hình 1: Đặt câu hỏi -->
    <div id="question-screen" class="screen active">
        <h1 class="title">Đặt câu hỏi cho trải bài Tarot</h1>
        <div id="question-input-area" class="question-input-area">
            <textarea id="question-input" class="question-input" placeholder="Khi nào tôi sẽ gặp được tình yêu mới?"></textarea>
        </div>
        <div class="suggested-questions">
            <button data-question="Người tiếp theo bước vào cuộc đời tôi sẽ có tính cách như thế nào?">Người tiếp theo bước vào cuộc đời tôi sẽ có tính cách như thế nào?</button>
            <button data-question="Tôi có nên cố gắng níu kéo mối quan hệ này không?">Tôi có nên cố gắng níu kéo mối quan hệ này không?</button>
            <button data-question="Tôi cần chuẩn bị như thế nào để đón nhận tương lai một cách tích cực?">Tôi cần chuẩn bị như thế nào để đón nhận tương lai một cách tích cực?</button>
            <button data-question="Tôi có nên đầu tư vào dự án hoặc cơ hội này không?">Tôi có nên đầu tư vào dự án hoặc cơ hội này không?</button>
        </div>
        <button id="submit-question-btn">Nhấn gửi câu hỏi để bắt đầu xáo bài</button>
    </div>

    <!-- Màn hình 2: Xáo bài -->
    <div id="shuffling-screen" class="screen">
        <div id="shuffling-question-display" class="question-display-header"></div>
        <div class="shuffling-animation-container">
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
        </div>
    </div>

    <!-- Màn hình 3: Chọn bài -->
    <div id="drawing-screen" class="screen">
        <div id="drawing-question-display" class="question-display-header"></div>
        <h2 class="drawing-subheader">Hãy chọn 3 lá bài</h2>
        
        <div id="chosen-cards-display">
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
        </div>
        
        <div id="card-spread-container">
            <!-- Hàng 1 & 2 cho Desktop -->
            <div class="card-row" id="card-row-1"></div>
            <div class="card-row" id="card-row-2"></div>
            <!-- 4 hàng cho Mobile -->
            <div class="card-row mobile-row" id="card-row-3"></div>
            <div class="card-row mobile-row" id="card-row-4"></div>
            <div class="card-row mobile-row" id="card-row-5"></div>
            <div class="card-row mobile-row" id="card-row-6"></div>
        </div>
        
        <div id="action-button-container">
            <button id="get-interpretation-button" class="action-button">Xem ý nghĩa</button>
        </div>
        
        <div id="interpretation-results-display"></div>
        
        <div id="follow-up-question-container">
            <h3>Bạn có câu hỏi nào khác không?</h3>
            <div id="follow-up-input-area" class="question-input-area">
                <textarea id="follow-up-question-input" class="question-input" placeholder="Đặt câu hỏi tiếp theo..."></textarea>
            </div>
            <button id="submit-follow-up-btn" class="action-button">
                Xáo bài cho câu hỏi mới
            </button>
        </div>
    </div>
    
    <!-- (CHỈNH SỬA) Modal Lịch sử -->
    <div id="history-modal-backdrop" class="modal-backdrop"></div>
    <div id="history-modal-content" class="modal-content">
        <!-- (MỚI) Wrapper cho tiêu đề và nút đóng -->
        <div class="modal-header">
            <button id="history-modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>Lịch sử trải bài</h2>
        </div>
        <!-- (MỚI) Wrapper cho nội dung cuộn -->
        <div id="history-list-wrapper" class="modal-scroll-wrapper">
            <div id="history-list">
                <!-- Lịch sử sẽ được render bằng JS -->
            </div>
        </div>
    </div>

    <script>
        const N8N_WEBHOOK_URL = 'https://n8n.n8ntuanphangz.xyz/webhook/2a1c95d5-dd30-4710-9f1c-f9c45686f218'; // !!! THAY THẾ URL CỦA BẠN !!!

        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const questionInput = document.getElementById('question-input');
        const submitQuestionBtn = document.getElementById('submit-question-btn');
        const suggestedQuestionBtns = document.querySelectorAll('.suggested-questions button');
        const cardRow1 = document.getElementById('card-row-1');
        const cardRow2 = document.getElementById('card-row-2');
        const cardRow3 = document.getElementById('card-row-3'); 
        const cardRow4 = document.getElementById('card-row-4');
        const cardRow5 = document.getElementById('card-row-5');
        const cardRow6 = document.getElementById('card-row-6');
        const chosenCardsDisplay = document.getElementById('chosen-cards-display'); 
        const shufflingQuestionDisplay = document.getElementById('shuffling-question-display');
        const drawingQuestionDisplay = document.getElementById('drawing-question-display');
        const getInterpretationButton = document.getElementById('get-interpretation-button');
        const mainResultsDisplay = document.getElementById('interpretation-results-display');
        const followUpContainer = document.getElementById('follow-up-question-container');
        const followUpInput = document.getElementById('follow-up-question-input');
        const followUpSubmitBtn = document.getElementById('submit-follow-up-btn');
        
        // DOM Elements cho Lịch sử
        const historyBtn = document.getElementById('history-btn');
        const historyBackdrop = document.getElementById('history-modal-backdrop');
        const historyModal = document.getElementById('history-modal-content');
        const historyCloseBtn = document.getElementById('history-modal-close-btn');
        const historyList = document.getElementById('history-list');


        // State
        let cardData = [];
        let selectedCards = [];
        let userQuestion = '';
        let isAnimating = false; 
        let readingHistory = []; 

        // === Functions ===
        
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        async function initialize() {
            const SHEET_ID = '1Bqu2RBPRH-YeCOiX_5SjmQP8GETpKkqBZhMPZwqm_ig';
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Cards&tqx=out:json&tq=SELECT%20*%20OFFSET%201`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                const table = JSON.parse(jsonText).table;

                cardData = table.rows.map((row, index) => ({
                    id: index,
                    name: row.c[0]?.v || 'Unknown Card',
                    image: row.c[1]?.v || 'https://placehold.co/200x340'
                }));
            } catch (error)
            {
                console.error("Lỗi khi tải lá bài:", error);
                document.getElementById('card-spread-container').innerHTML = '<p>Lỗi tải bộ bài. Vui lòng tải lại trang.</p>';
            }
        }

        function handleQuestionSubmit() {
            const questionFromInput = questionInput.value.trim();
            if (!questionFromInput) {
                questionInput.style.borderColor = 'red';
                setTimeout(() => { questionInput.style.borderColor = ''; }, 2000);
                return;
            }
            userQuestion = questionFromInput;
            startNewReadingFlow();
        }
        
        function handleFollowUpSubmit() {
            const questionFromInput = followUpInput.value.trim();
            if (!questionFromInput) {
                followUpInput.style.borderColor = 'red';
                setTimeout(() => { followUpInput.style.borderColor = ''; }, 2000);
                return;
            }
            userQuestion = questionFromInput;
            followUpInput.value = '';
            startNewReadingFlow();
        }
        
        function startNewReadingFlow() {
            sessionStorage.removeItem('tarotSession'); 
            
            shufflingQuestionDisplay.textContent = userQuestion;
            drawingQuestionDisplay.textContent = userQuestion;
            showScreen('shuffling-screen');
            setTimeout(() => {
                populateCardDeck();
                showScreen('drawing-screen');
            }, 2500); 
        }

        function populateCardDeck() {
            cardRow1.innerHTML = '';
            cardRow2.innerHTML = '';
            cardRow3.innerHTML = '';
            cardRow4.innerHTML = '';
            cardRow5.innerHTML = '';
            cardRow6.innerHTML = '';
            selectedCards = []; 
            mainResultsDisplay.style.display = 'none';
            mainResultsDisplay.innerHTML = '';
            updateChosenCardsDisplay();

            const drawingScreen = document.getElementById('drawing-screen');
            drawingScreen.classList.remove('results-active');
            
            getInterpretationButton.classList.remove('visible');
            getInterpretationButton.style.display = 'none';
            
            followUpContainer.style.display = 'none';

            for (let i = 0; i < 78; i++) {
                const cardElementDesktop = document.createElement('div');
                cardElementDesktop.className = 'facedown-card';
                cardElementDesktop.dataset.positionIndex = i;
                cardElementDesktop.style.animation = `dealCardIn 0.3s ease-out forwards ${i * 30}ms`;
                
                const cardElementMobile = cardElementDesktop.cloneNode(true);
                
                const animationEndCallback = (e) => {
                    if (e.animationName === 'dealCardIn') {
                        e.target.classList.add('is-dealt'); 
                        e.target.style.animation = ''; 
                    }
                };
                cardElementDesktop.addEventListener('animationend', animationEndCallback);
                cardElementMobile.addEventListener('animationend', animationEndCallback);
                
                cardElementDesktop.addEventListener('click', (e) => handleCardSelection(e, cardElementDesktop));
                cardElementMobile.addEventListener('click', (e) => handleCardSelection(e, cardElementMobile));
                
                cardElementDesktop.addEventListener('touchstart', (e) => handleCardSelection(e, cardElementDesktop));
                cardElementMobile.addEventListener('touchstart', (e) => handleCardSelection(e, cardElementMobile));

                if (i < 39) {
                    cardRow1.appendChild(cardElementDesktop);
                } else {
                    cardRow2.appendChild(cardElementDesktop);
                }
                
                if (i < 20) {
                    cardRow3.appendChild(cardElementMobile);
                } else if (i < 40) {
                    cardRow4.appendChild(cardElementMobile);
                } else if (i < 60) {
                    cardRow5.appendChild(cardElementMobile);
                } else {
                    cardRow6.appendChild(cardElementMobile);
                }
            }
        }

        function handleCardSelection(event, clickedElement) {
            event.preventDefault();
            
            if (selectedCards.length >= 3 || isAnimating) return;

            const posIndex = clickedElement.dataset.positionIndex;
            const allCardsWithIndex = document.querySelectorAll(`.facedown-card[data-position-index="${posIndex}"]`);

            let alreadyChosen = false;
            allCardsWithIndex.forEach(card => {
                if (card.classList.contains('is-chosen')) {
                    alreadyChosen = true;
                }
            });
            if (alreadyChosen) return;

            isAnimating = true; 

            allCardsWithIndex.forEach(card => card.classList.add('is-chosen'));

            const availableCards = cardData.filter(card => !selectedCards.some(sc => sc.id === card.id));
            const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
            const isReversed = Math.random() < 0.5;
            const orientation = isReversed ? 'Ngược' : 'Xuôi';
            const chosenCard = { ...randomCard, isReversed, orientation };

            const targetPlaceholder = document.querySelectorAll('#chosen-cards-display .chosen-card-placeholder')[0];
            
            if (targetPlaceholder) {
                animateCardFlight(clickedElement, targetPlaceholder, chosenCard);
            } else {
                isAnimating = false;
            }
        }

        function animateCardFlight(startEl, endEl, cardData) {
            
            const img = new Image();
            
            const onImageLoaded = () => {
                const startRect = startEl.getBoundingClientRect();
                const endRect = endEl.getBoundingClientRect();
                
                const flyingCard = document.createElement('div');
                flyingCard.className = 'flying-card-animator';
                
                const reversedClass = cardData.isReversed ? 'reversed' : '';
                flyingCard.innerHTML = `
                    <div class="flying-card-inner">
                        <div class="flying-card-back"></div>
                        <div class="flying-card-front">
                            <img src="${cardData.image}" alt="${cardData.name}" class="${reversedClass}">
                        </div>
                    </div>
                `;
                
                flyingCard.style.top = `${startRect.top + window.scrollY}px`;
                flyingCard.style.left = `${startRect.left}px`;
                flyingCard.style.width = `${startRect.width}px`;
                flyingCard.style.height = `${startRect.height}px`;
                
                document.body.appendChild(flyingCard);
                
                requestAnimationFrame(() => {
                    const inner = flyingCard.querySelector('.flying-card-inner');
                    
                    flyingCard.style.top = `${endRect.top + window.scrollY}px`;
                    flyingCard.style.left = `${endRect.left}px`;
                    flyingCard.style.width = `${endRect.width}px`;
                    flyingCard.style.height = `${endRect.height}px`;
                    
                    inner.style.transform = 'rotateY(180deg) translateZ(0)';
                });

                let flightHasEnded = false;
                
                const onFlightEnd = (event) => {
                    if (event.target !== flyingCard || flightHasEnded) {
                        return;
                    }
                    flightHasEnded = true; 

                    flyingCard.removeEventListener('transitionend', onFlightEnd);
                    flyingCard.remove();
                    
                    selectedCards.push(cardData);
                    updateChosenCardsDisplay(); 

                    if (selectedCards.length === 3) {
                        transitionToResultsView();
                    }
                    
                    isAnimating = false; 
                };
                
                flyingCard.addEventListener('transitionend', onFlightEnd);
            };

            img.onload = onImageLoaded; 
            img.onerror = onImageLoaded; 
            img.src = cardData.image; 
        }


        function updateChosenCardsDisplay() {
            chosenCardsDisplay.innerHTML = '';
            let cardItemElements = []; 
            
            selectedCards.forEach(card => {
                const cardItem = document.createElement('div');
                cardItem.className = 'chosen-card-item';
                cardItem.innerHTML = `
                    <div class="card-image-wrapper">
                        <img src="${card.image}" alt="${card.name}" class="${card.isReversed ? 'reversed' : ''}">
                    </div>
                    <div class="card-info">
                        <div class="card-name">${card.name}</div>
                        ${card.isReversed ? '<div class="card-orientation">(Lá bài Ngược)</div>' : ''}
                    </div>
                `;
                cardItemElements.push(cardItem); 
            });
            
            cardItemElements.forEach(item => {
                chosenCardsDisplay.appendChild(item);
                setTimeout(() => {
                    item.style.opacity = '1';
                }, 0);
            });

            for (let i = 0; i < 3 - selectedCards.length; i++) {
                chosenCardsDisplay.innerHTML += '<div class="chosen-card-placeholder"></div>';
            }
        }

        function transitionToResultsView() {
            const drawingScreen = document.getElementById('drawing-screen');
            drawingScreen.classList.add('results-active');
            
            getInterpretationButton.style.display = 'inline-block'; 
            setTimeout(() => {
                getInterpretationButton.classList.add('visible');
            }, 300); 
        }

        // (CHỈNH SỬA) Thay đổi logic lưu lịch sử
        async function handleGetInterpretation() {
            mainResultsDisplay.style.display = 'block';
            mainResultsDisplay.innerHTML = '<p>Đang luận giải, vui lòng chờ trong giây lát...</p>';
            
            getInterpretationButton.classList.remove('visible');
            setTimeout(() => {
                getInterpretationButton.style.display = 'none';
            }, 300);
            
            const payload = {
                question: userQuestion,
                cards: selectedCards.map(c => ({ name: c.name, orientation: c.orientation }))
            };

            // (THAY ĐỔI) Sẽ lưu lịch sử SAU KHI fetch thành công

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Lỗi từ server: ${response.statusText}`);

                const result = await response.json();
                
                if (result && result.length > 0 && result[0].interpretation) {
                    const converter = new showdown.Converter();
                    const markdownContent = result[0].interpretation; // Giữ markdown gốc
                    const htmlContent = converter.makeHtml(markdownContent);
                    mainResultsDisplay.innerHTML = htmlContent; 

                    // (MỚI) Chuyển đổi HTML sang Text đơn giản
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = htmlContent;
                    const plainTextContent = (tempDiv.textContent || tempDiv.innerText || "").trim();

                    // (MỚI) Tạo đối tượng Lịch sử & Session SAU KHI có nội dung
                    const fullEntry = { 
                        id: Date.now(), 
                        question: userQuestion, 
                        cards: selectedCards, // Lưu mảng đầy đủ
                        html: htmlContent, // Lưu HTML (dự phòng)
                        text: plainTextContent, // Lưu Text để chia sẻ
                        markdown: markdownContent // Lưu Markdown (dự phòng)
                    };

                    // (MỚI) Lưu vào Lịch sử (localStorage)
                    saveHistory(fullEntry);

                    // (MỚI) Lưu vào Session (sessionStorage)
                    const sessionState = {
                        ...fullEntry, 
                        screen: 'drawing-screen results-active'
                    };
                    sessionStorage.setItem('tarotSession', JSON.stringify(sessionState));

                } else {
                    throw new Error("Dữ liệu trả về không đúng định dạng.");
                }
            } catch (error) {
                console.error("Lỗi khi gọi Webhook:", error);
                mainResultsDisplay.innerHTML = `<p>Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại sau.</p>`;
            }
            
            mainResultsDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            followUpContainer.style.display = 'block';
        }

        // === Chức năng Lịch sử ===
        function loadHistory() {
            const storedHistory = localStorage.getItem('tarotHistory');
            readingHistory = storedHistory ? JSON.parse(storedHistory) : [];
        }

        function saveHistory(reading) {
            readingHistory.unshift(reading); // Thêm vào đầu mảng
            if (readingHistory.length > 20) { // Giới hạn 20 lần
                readingHistory.pop();
            }
            localStorage.setItem('tarotHistory', JSON.stringify(readingHistory));
        }

        // (CHỈNH SỬA) Cập nhật render để thêm nút Chia sẻ
        function renderHistoryList() {
            historyList.innerHTML = '';
            if (readingHistory.length === 0) {
                historyList.innerHTML = '<p style="opacity: 0.7; text-align: center;">Chưa có lịch sử trải bài.</p>';
                return;
            }

            readingHistory.forEach(reading => {
                const itemEl = document.createElement('div');
                itemEl.className = 'history-item';

                let cardsHtml = '';
                reading.cards.forEach(card => {
                    cardsHtml += `
                        <div class="history-card-item">
                            <img src="${card.image}" alt="${card.name}" class="${card.isReversed ? 'reversed' : ''}">
                            <div class="card-name">${card.name}</div>
                            ${card.isReversed ? `<div class="card-orientation">${card.orientation}</div>` : ''}
                        </div>
                    `;
                });

                // (MỚI) Chỉ thêm nút Share nếu có nội dung text
                const shareButtonHtml = reading.text ? 
                    `<button class="history-share-btn" data-reading-id="${reading.id}">Chia sẻ</button>` :
                    '';

                itemEl.innerHTML = `
                    <h3>${reading.question}</h3>
                    <div class="history-date">${new Date(reading.id).toLocaleString('vi-VN')}</div>
                    <div class="history-cards-container">
                        ${cardsHtml}
                    </div>
                    ${shareButtonHtml} <!-- (MỚI) Thêm nút vào đây -->
                `;
                historyList.appendChild(itemEl);
            });
        }

        function openHistoryModal() {
            renderHistoryList();
            historyBackdrop.style.display = 'block';
            historyModal.style.display = 'flex'; // (THAY ĐỔI) Đổi thành 'flex'
        }

        function closeHistoryModal() {
            historyBackdrop.style.display = 'none';
            historyModal.style.display = 'none';
        }

        // (MỚI) Hàm xử lý click trong modal lịch sử (event delegation)
        function handleHistoryClick(event) {
            const shareButton = event.target.closest('.history-share-btn');
            if (shareButton) {
                // Vô hiệu hóa nút tạm thời
                shareButton.disabled = true;

                const readingId = shareButton.dataset.readingId;
                const reading = readingHistory.find(r => r.id == readingId);
                
                if (reading && reading.text) {
                    shareReading(reading, shareButton); // Truyền nút vào để cập nhật UI
                } else {
                    console.error('Không tìm thấy nội dung để chia sẻ.');
                    updateShareButtonState(shareButton, 'Lỗi', 'error');
                }
            }
        }
        
        // (MỚI) Hàm chia sẻ (Web Share API hoặc Clipboard)
        async function shareReading(reading, buttonEl) {
            const title = `Trải bài Tarot: ${reading.question}`;
            // (MỚI) Tạo nội dung text rõ ràng hơn
            const cardNames = reading.cards.map(c => `${c.name} ${c.isReversed ? '(Ngược)' : ''}`).join(', ');
            const text = `Câu hỏi: ${reading.question}\nBài: ${cardNames}\n\nLuận giải:\n${reading.text}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: text,
                    });
                    console.log('Chia sẻ thành công');
                    updateShareButtonState(buttonEl, 'Đã chia sẻ!', 'success');
                } catch (error) {
                    console.error('Lỗi khi chia sẻ:', error);
                    updateShareButtonState(buttonEl, 'Chia sẻ thất bại', 'error');
                }
            } else {
                // Fallback: Copy to clipboard
                try {
                    await navigator.clipboard.writeText(text);
                    updateShareButtonState(buttonEl, 'Đã sao chép!', 'success');
                } catch (err) {
                    console.error('Lỗi khi sao chép:', err);
                    updateShareButtonState(buttonEl, 'Lỗi sao chép', 'error');
                }
            }
        }

        // (MỚI) Hàm helper để cập nhật trạng thái nút chia sẻ
        function updateShareButtonState(button, message, state) {
            if (!button) return;
            const originalText = 'Chia sẻ';
            button.textContent = message;
            if(state) button.classList.add(state); // 'success' hoặc 'error'
            
            // Reset sau 2 giây
            setTimeout(() => {
                button.textContent = originalText;
                if(state) button.classList.remove(state);
                button.disabled = false; // Kích hoạt lại nút
            }, 2000);
        }


        // === Chức năng Session ===
        function loadSessionState() {
            const savedState = sessionStorage.getItem('tarotSession');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.screen === 'drawing-screen results-active' && state.question && state.cards && state.html) {
                        userQuestion = state.question;
                        selectedCards = state.cards;

                        shufflingQuestionDisplay.textContent = userQuestion;
                        drawingQuestionDisplay.textContent = userQuestion;
                        
                        updateChosenCardsDisplay(); 
                        
                        mainResultsDisplay.innerHTML = state.html;
                        mainResultsDisplay.style.display = 'block';
                        
                        document.getElementById('drawing-screen').classList.add('results-active');
                        followUpContainer.style.display = 'block';
                        
                        showScreen('drawing-screen');
                        return; 
                    }
                } catch (e) {
                    console.error("Lỗi parse session:", e);
                    sessionStorage.removeItem('tarotSession'); 
                }
            }
            showScreen('question-screen');
        }


        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', async () => {
            await initialize(); 
            loadHistory();      
            loadSessionState(); 
        });

        submitQuestionBtn.addEventListener('click', handleQuestionSubmit);
        suggestedQuestionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                questionInput.value = btn.dataset.question;
            });
        });
        
        getInterpretationButton.addEventListener('click', handleGetInterpretation);
        followUpSubmitBtn.addEventListener('click', handleFollowUpSubmit);
        
        // Listeners cho Modal Lịch sử
        historyBtn.addEventListener('click', openHistoryModal);
        historyBackdrop.addEventListener('click', closeHistoryModal);
        historyCloseBtn.addEventListener('click', closeHistoryModal);
        
        // (MỚI) Listener cho các nút bên trong lịch sử
        historyList.addEventListener('click', handleHistoryClick);

    </script>
</body>
</html>
