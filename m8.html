<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THACO Auto TPHCM - Trang Chủ</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- 360 Viewer Script -->
  <script src="https://cdn.scaleflex.it/plugins/js-cloudimage-360-view/2.5.0/js-cloudimage-360-view.min.js"></script>

  <style>
    body {margin:0;font-family:Arial,sans-serif;background:#f5f7fa;color:#333;}
header {background:#004b9b;padding:10px 40px;color:#fff;}
.top-bar {display:flex;align-items:center;justify-content:space-between;gap:20px;}
.logo img {height:30px;}
.banner img{width:100%;height:auto;display:block;}

/* Sort bar */
.sort-bar {margin:2rem 3rem;font-size:14px;color:#444;}
.sort-bar span {margin-right:10px;}
.sort-bar a {margin:0 8px;text-decoration:none;color:#444;cursor:pointer;}
.sort-bar a.active {color:#004b9b;font-weight:bold;}
.sort-price {display:inline-block;position:relative;margin-left:8px;cursor:pointer;}
.sort-price:hover .dropdown {display:block;}
.sort-price .dropdown {
  display:none;position:absolute;background:#fff;border:1px solid #ddd;
  padding:5px 0;list-style:none;margin:0;top:18px;left:0;min-width:120px;z-index:10;
}
.sort-price .dropdown li {padding:6px 12px;cursor:pointer;font-size:13px;}
.sort-price .dropdown li:hover {background:#f5f5f5;}

/* Product grid */
.all-cars {padding:0 20px 40px;flex:1;transition:all 0.4s ease;}
.product-grid {
  display:grid;
  gap:20px;
  transition:all 0.4s ease;
}
.product-card {background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform .2s;position:relative;}
.product-card:hover {transform:translateY(-5px);}
.product-info h3 {margin:0;font-size:16px;color:#004b9b;}
.version-tags {margin:10px 0;display:flex;flex-wrap:wrap;gap:6px;}
.version-tag {background:#eee;color:#333;font-size:12px;padding:4px 8px;border-radius:4px;cursor:pointer;}
.version-tag.active{background:#004b9b;color:#fff;}
.main-price {margin-top:5px;font-size:18px;font-weight:bold;color:#004b9b;}
.btn-group {margin-top:10px;display:flex;gap:10px;}
.btn-estimate {flex:1;background:#004b9b;color:#fff;padding:8px 15px;border-radius:5px;text-decoration:none;font-size:14px;text-align:center;}
.btn-contact {flex:1;background:#fff;border:2px solid #004b9b;color:#004b9b;padding:8px 15px;border-radius:5px;text-decoration:none;font-size:14px;text-align:center;}
.tags {position:absolute;top:10px;left:10px;display:flex;gap:6px;}
.tag {background:#004b9b;color:#fff;font-size:12px;padding:4px 8px;border-radius:4px;}
footer{text-align:center;padding:20px;background:#004b9b;color:#fff;margin-top:40px;}

/* ==== Main Layout dùng Flex ==== */
.main-layout {
  display: flex;
  margin:20px;
  transition: all 0.4s ease;
}
.main-layout.full-width .all-cars {
  flex:1;
}

/* Sidebar có hiệu ứng co giãn */
.filter-sidebar {
  flex-basis: 24rem;   /* thay width bằng flex-basis */
  max-width: 30rem;
  transition: max-width 0.2s ease, opacity 0.3s ease;
  opacity: 1;
  overflow: hidden;
  padding: 0 20px;

}

@media (max-width: 1200px){
  .filter-sidebar {
    flex-basis: 21rem;
    max-width: 21rem;
  }
}

.main-layout.full-width .filter-sidebar {
  max-width: 0;     /* thu gọn ngay tại chỗ */
  opacity: 0;
  padding: 0;
}


/* Filter box */
.filter-box {
  background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.15);
}
.filter-box h3 {margin:15px 0 10px;color:#004b9b;font-size:16px;}
.filter-options {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
.filter-option {
  border:2px solid #ccc;padding:8px 14px;border-radius:6px;cursor:pointer;
  font-size:14px;transition:all 0.2s ease;
}
.filter-option:hover {border-color:#004b9b;}
.filter-option.active {border-color:#004b9b;background:#e6f0ff;font-weight:bold;}

#filter-brand .filter-option {border-radius:8px;width:70px;height:70px;display:flex;align-items:center;justify-content:center;background:#fff;}
#filter-brand .filter-option img {width:100%;object-fit:contain;}
#filter-brand .filter-option.active {border-color:#004b9b;background:#e6f0ff;}

.filter-actions {display:flex;justify-content:space-between;gap:10px;margin-top:10px;}
.btn-reset {background:#f1f1f1;color:#333;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;}
.btn-apply {background:#004b9b;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;}

/* Toggle buttons */
.filter-toggle-bar {
  display:flex;
  justify-content:flex-start;
  padding:1rem 3rem;
}
.toggle-btn {
  background:#004b9b;
  color:#fff;
  border:none;
  padding:8px 16px;
  border-radius:6px;
  cursor:pointer;
}

/* Responsive grid */
/* Desktop */
@media (min-width:1200px){
  .product-grid{grid-template-columns:repeat(3,1fr);}
  .main-layout.full-width .product-grid{grid-template-columns:repeat(4,1fr);}
}
/* Tablet */
@media (min-width:768px) and (max-width:1199px){
  .product-grid{grid-template-columns:repeat(2,1fr);}
  .main-layout.full-width .product-grid{grid-template-columns:repeat(3,1fr);}
}
/* Mobile */
@media (max-width:767px){
  .main-layout{flex-direction:column;}
  .filter-sidebar{width:100%;order:-1;}
  .main-layout.full-width .filter-sidebar{width:0;opacity:0;}
  .product-grid{grid-template-columns:repeat(2,1fr);}
}

.img-frame {width:100%;aspect-ratio:4/2.5;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:8px;}
.img-frame img {max-width:100%;max-height:100%;object-fit:contain;}

/* tag filter */
.active-filters {display:flex;flex-wrap:wrap;gap:10px;margin-left:3rem;}
.filter-tag {display:flex;align-items:center;background:#e6f0ff;border:1px solid #004b9b;border-radius:10px;padding:5px 12px;font-size:14px;color:#004b9b;}
.filter-tag button {margin-left:8px;border:none;background:transparent;color:#004b9b;font-size:16px;cursor:pointer;}
.filter-tag button:hover {color:#d00;}

  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="top-bar">
      <div class="logo">
        <a href="index.html"><img src="logo-thaco-hcm.png" alt="THACO AUTO Logo"></a>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <div class="banner">
    <img src="web-cty-tt-01.png" alt="THACO Auto Banner">
  </div>

  <!-- Sort menu -->
  <div class="sort-bar">
    <span>Sắp xếp theo:</span>
    <a href="#" onclick="sortSpecial(event,'highlight')" id="sort-highlight">Nổi bật</a>
    <a href="#" onclick="sortSpecial(event,'bestseller')" id="sort-bestseller">Bán chạy</a>
    <a href="#" onclick="sortSpecial(event,'promo')" id="sort-promo">Ưu đãi</a>
    <a href="#" onclick="sortSpecial(event,'new')" id="sort-new">Mới</a>
    <div class="sort-price">
      <span>Giá ▾</span>
      <ul class="dropdown">
        <li onclick="sortCarsByPrice('asc')">Thấp → Cao</li>
        <li onclick="sortCarsByPrice('desc')">Cao → Thấp</li>
      </ul>
    </div>
  </div>

  <!-- Active Filters -->
  <div class="active-filters" id="active-filters"></div>

  <!-- Nút toggle filter -->
  <div class="filter-toggle-bar">
  <button class="toggle-btn" id="toggleFilter">
    <i class="fa-solid fa-square-caret-left"></i>
  </button>
</div>

  <!-- Layout -->
  <div class="main-layout" id="mainLayout">
    <!-- Sidebar -->
    <aside class="filter-sidebar" id="filterSidebar">

      <div class="filter-box mb-4">

        <h3>Thương hiệu</h3>
        <div class="filter-options" id="filter-brand">
          <div class="filter-option" data-filter="brand" data-value="bmw"><img src="https://thacoauto.vn/storage/brands/bmw-logo-2-1.png" alt="BMW" /></div>
          <div class="filter-option" data-filter="brand" data-value="mini"><img src="https://thacoauto.vn/storage/brands/pngwingcom-1.png" alt="MINI" /></div>
          <div class="filter-option" data-filter="brand" data-value="peugeot"><img src="https://thacoauto.vn/storage/brands/peugeot-logo-1.png" alt="Peugeot" /></div>
          <div class="filter-option" data-filter="brand" data-value="mazda"><img src="https://thacoauto.vn/storage/brands/mazda-5.png" alt="Mazda" /></div>
          <div class="filter-option" data-filter="brand" data-value="kia"><img src="https://thacoauto.vn/storage/brands/kia-motors-new-2021.png" alt="KIA" /></div>
        </div>

        <h3>Giá</h3>
        <div class="filter-options" id="filter-price">
          <div class="filter-option" data-filter="price" data-value="200000000-400000000">200 - 400 triệu</div>
          <div class="filter-option" data-filter="price" data-value="400000000-600000000">400 - 600 triệu</div>
          <div class="filter-option" data-filter="price" data-value="600000000-800000000">600 - 800 triệu</div>
          <div class="filter-option" data-filter="price" data-value="800000000-1000000000">800 triệu - 1 tỷ</div>
          <div class="filter-option" data-filter="price" data-value="1000000000-2000000000">1 - 2 tỷ</div>
          <div class="filter-option" data-filter="price" data-value="2000000000+">Trên 2 tỷ</div>
        </div>

        <h3>Phân khúc xe</h3>
        <div class="filter-options" id="filter-type">
          <div class="filter-option" data-filter="type" data-value="Sedan">Sedan</div>
          <div class="filter-option" data-filter="type" data-value="SUV">SUV</div>
          <div class="filter-option" data-filter="type" data-value="Hatchback">Hatchback</div>
        </div>

        <h3>Nhiên liệu</h3>
        <div class="filter-options" id="filter-fuel">
          <div class="filter-option" data-filter="fuel" data-value="Xăng">Xăng</div>
          <div class="filter-option" data-filter="fuel" data-value="Dầu">Dầu</div>
          <div class="filter-option" data-filter="fuel" data-value="Hybrid">Hybrid</div>
        </div>

        <h3>Số chỗ ngồi</h3>
        <div class="filter-options" id="filter-seats">
          <div class="filter-option" data-filter="seats" data-value="5">5 chỗ</div>
          <div class="filter-option" data-filter="seats" data-value="7">7 chỗ</div>
          <div class="filter-option" data-filter="seats" data-value="8">8 chỗ</div>
        </div>

        <h3>Màu sắc</h3>
        <div class="filter-options" id="filter-color">
          <div class="filter-option" data-filter="color" data-value="Đen">Đen</div>
          <div class="filter-option" data-filter="color" data-value="Trắng">Trắng</div>
          <div class="filter-option" data-filter="color" data-value="Xám">Xám</div>
          <div class="filter-option" data-filter="color" data-value="Đỏ">Đỏ</div>
          <div class="filter-option" data-filter="color" data-value="Bạc">Bạc</div>
          <div class="filter-option" data-filter="color" data-value="Xanh dương">Xanh dương</div>
        </div>

        <div class="filter-actions">
          <button class="btn-reset" id="resetFilter">Bỏ chọn</button>
          <button class="btn-apply" id="applyFilter">Xem sản phẩm</button>
        </div>
      </div>

    </aside>

    <!-- Products -->
    <section class="all-cars container-fluid">
      <div class="product-grid" id="product-grid"></div>
    </section>
  </div>

  <!-- Footer -->
  <footer>
    © 2025 THACO Auto TPHCM. Tất cả các quyền được bảo lưu.
  </footer>

<script>
let carsData = [];
let currentBrand = "all";
let currentSort = null;
let currentFilters = {};


document.addEventListener("DOMContentLoaded", async () => {
  await loadCars();
  const grid = document.getElementById("product-grid");
  grid.addEventListener("click", (e) => {
    const tag = e.target.closest(".version-tag");
    if (!tag) return;
    const card = tag.closest(".product-card");
    if (!card) return;
    card.querySelectorAll(".version-tag").forEach(t => t.classList.remove("active"));
    tag.classList.add("active");
    const priceOriginal = parseInt(tag.dataset.original || 0, 10);
    const priceDiscount = parseInt(tag.dataset.discount || 0, 10);
    const priceMainEl = card.querySelector(".main-price");
    priceMainEl.textContent = formatCurrency(priceOriginal || priceDiscount);
  });
});

async function loadCars() {
  try {
    const res = await fetch("cars_1.json");
    carsData = await res.json();
    console.log("✅ Cars JSON:", carsData);
    applyFiltersAndSort();
  } catch (err) {
    console.error("❌ Lỗi loadCars:", err);
    document.getElementById("product-grid").innerHTML =
      "<p style='color:red'>Không tải được dữ liệu</p>";
  }
}


function normalizeVersions(car) {
  const raw = Array.isArray(car.versions) ? car.versions : [];
  if (raw.length === 0) {
    const p = toNumber(car.price);
    return [{ name: "Tiêu chuẩn", originalPrice: p, discountPrice: p }];
  }
  if (typeof raw[0] === "object") {
    return [...raw].sort((a, b) => a.discountPrice - b.discountPrice);
  }
  const base = toNumber(car.price);
  return raw.map(name => ({ name, originalPrice: base, discountPrice: base }))
            .sort((a, b) => a.discountPrice - b.discountPrice);
}

function getMinPrice(car) {
  const versions = normalizeVersions(car);
  return versions[0]?.discountPrice || 0;
}

function applyFiltersAndSort() {
  let filtered = [...carsData];
  if (currentBrand !== "all") filtered = filtered.filter(c => c.brand === currentBrand);
  if (currentFilters.brand?.length) filtered = filtered.filter(car => currentFilters.brand.includes(car.brand));
  if (currentFilters.price?.length) {
    filtered = filtered.filter(car => {
      const minPrice = getMinPrice(car);
      return currentFilters.price.some(p => {
        if (p.endsWith("+")) {const min = parseInt(p);return minPrice >= min;}
        else {const [min, max] = p.split("-").map(v => parseInt(v, 10));return minPrice >= min && minPrice <= max;}
      });
    });
  }
  if (currentFilters.type?.length) filtered = filtered.filter(car => currentFilters.type.some(t => (car.type || "").includes(t)));
  if (currentFilters.fuel?.length) filtered = filtered.filter(car => Array.isArray(car.fuel) && car.fuel.some(fuel => currentFilters.fuel.includes(fuel)));
  if (currentFilters.seats?.length) filtered = filtered.filter(car => Array.isArray(car.seats) && car.seats.some(seat => currentFilters.seats.includes(String(seat))));
  if (currentFilters.color?.length) filtered = filtered.filter(car => car.versions.some(v => v.color_exterior.some(c => currentFilters.color.includes(c))));
  if (currentSort === "asc") filtered.sort((a, b) => getMinPrice(a) - getMinPrice(b));
  else if (currentSort === "desc") filtered.sort((a, b) => getMinPrice(b) - getMinPrice(a));
  else if (["highlight","new","bestseller"].includes(currentSort)) filtered.sort((a, b) => (!!a[currentSort] === !!b[currentSort]) ? 0 : a[currentSort] ? -1 : 1);
  else if (currentSort === "promo") filtered.sort((a, b) => {const aP = !!(a.promo && a.promo.trim() !== "");const bP = !!(b.promo && b.promo.trim() !== "");return aP === bP ? 0 : aP ? -1 : 1;});
  renderCars(filtered);
  renderActiveFilters();
}

function renderActiveFilters() {
  const container = document.getElementById("active-filters");
  if (!container) return;
  container.innerHTML = "";
  Object.keys(currentFilters).forEach(key => {
    currentFilters[key].forEach(value => {
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      tag.innerHTML = `${value} <button onclick="removeFilter('${key}','${value}')">&times;</button>`;
      container.appendChild(tag);
    });
  });
}
function removeFilter(key, value) {
  if (!currentFilters[key]) return;
  currentFilters[key] = currentFilters[key].filter(v => v !== value);
  document.querySelectorAll(`.filter-option[data-filter="${key}"][data-value="${value}"]`).forEach(opt => opt.classList.remove("active"));
  if (currentFilters[key].length === 0) delete currentFilters[key];
  applyFiltersAndSort();
}
function formatCurrency(num) {return num.toLocaleString("vi-VN") + "đ";}
function toNumber(val) {if (typeof val === "number") return val;if (!val) return 0;return parseInt(String(val).replace(/[^\d]/g, ""), 10) || 0;}
function slugify(name) {return String(name).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-');}
function renderCars(cars) {
  const container = document.getElementById("product-grid");
  container.innerHTML = "";
  cars.forEach(car => {
    const slug = slugify(car.name);
    const versions = normalizeVersions(car);
    const defaultVersion = versions[0];
    let tags = [];
    if (car.highlight) tags.push("Nổi bật");
    if (car.bestseller) tags.push("Bán chạy");
    if (car.new) tags.push("Xe mới");
    const tagsHTML = tags.length ? `<div class="tags">${tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>` : "";
    const versionTagsHTML = versions.map((v, i) => `<span class="version-tag${i===0 ? " active" : ""}" data-original="${v.originalPrice}" data-discount="${v.discountPrice}">${v.name}</span>`).join("");
    const card = `<div class="product-card ${car.brand} p-3 d-flex flex-column">${tagsHTML}<a href="#" data-slug="${slug}" style="text-decoration:none;color:inherit"><div class="img-frame"><img src="${car.img}" alt="${car.name}"/></div></a><div class="product-info mt-2 d-flex flex-column flex-grow-1"><h3><a href="#" data-slug="${slug}" style="text-decoration:none;color:#004b9b">${car.name}</a></h3><div class="version-tags">${versionTagsHTML}</div><div class="price-block"><div class="main-price">${formatCurrency(defaultVersion.originalPrice || defaultVersion.discountPrice)}</div></div><div class="btn-group mt-2"><a class="btn-estimate" href="#" data-slug="${slug}">Dự toán</a><a class="btn-contact" href="#">Liên hệ</a></div></div></div>`;
    container.innerHTML += card;
  });
}

// SORT
function sortCarsByPrice(order) {currentSort = order;setActiveSort(null);applyFiltersAndSort();}
function sortSpecial(e, type) {if (e) e.preventDefault();currentSort = type;setActiveSort(type);applyFiltersAndSort();}
function setActiveSort(type) {document.querySelectorAll(".sort-bar a").forEach(a => a.classList.remove("active"));if (type) {const el = document.getElementById(`sort-${type}`);if (el) el.classList.add("active");}}

// FILTER sidebar
document.querySelectorAll(".filter-option").forEach(opt => {opt.addEventListener("click", () => opt.classList.toggle("active"));});
document.getElementById("resetFilter").addEventListener("click", () => {document.querySelectorAll(".filter-option.active").forEach(opt => opt.classList.remove("active"));currentFilters = {};applyFiltersAndSort();});
document.getElementById("applyFilter").addEventListener("click", () => {currentFilters = {};document.querySelectorAll(".filter-option.active").forEach(opt => {const key = opt.dataset.filter;const value = opt.dataset.value;if (!currentFilters[key]) currentFilters[key] = [];currentFilters[key].push(value);});applyFiltersAndSort();});

// Toggle Filter
const toggleBtn = document.getElementById("toggleFilter");
const mainLayout = document.getElementById("mainLayout");
const filterSidebar = document.getElementById("filterSidebar");

toggleBtn.addEventListener("click", () => {
  const icon = toggleBtn.querySelector("i");
  mainLayout.classList.toggle("full-width");   // 🔥 chỉ toggle class này thôi

  if (mainLayout.classList.contains("full-width")) {
    icon.classList.remove("fa-square-caret-left");
    icon.classList.add("fa-square-caret-right");
  } else {
    icon.classList.remove("fa-square-caret-right");
    icon.classList.add("fa-square-caret-left");
  }
});


</script>


  <!-- ====== E-CATALOG POPUP DETAIL (non-invasive) ====== -->
  <style>
    /* Namespaced to avoid collisions */
    .ecat-mask {
      position: fixed;
      inset: 0;
      background: #fff;       /* bỏ nền mờ, dùng nền trắng toàn trang */
      display: none;
      z-index: 9999;
      overflow-y: auto;       /* chính modal cuộn luôn */
    }
    .ecat-mask.ecat-open {
      display: block;
    }

    .ecat-panel {
      width: 100vw;
      min-height: 100vh;
      background: #fff;
      border-radius: 0;
      position: relative;
      padding: 0; 
      display: flex;
      flex-direction: column;
      overflow: visible;
    }

    @media(max-width:1024px){.ecat-panel{width:100vw;height:95vh}}

    .ecat-x {
      position: fixed; 
      top: 20px;
      right: 20px;
      z-index: 10001; 
      background: rgba(243,244,246,0.8);
      border: 1px solid #ddd;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(3px);
    }

    .ecat-video {
      position: relative;
      width: 100%;
      max-width: 100%;
      z-index: 1;
      aspect-ratio: 16/9;   /* 🔥 luôn giữ đúng 16:9 */
      background: #000;
      border-radius: 0;     /* hoặc 12px nếu muốn bo góc */
      overflow: hidden;
    }

    #ecatVideoHero iframe {
      position: absolute;
      inset: 0;
      width: 100vw;
      height:56.25vw;
      border: 0;
    }

    .ecat-video::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 2;
    }


    .ecat-grid{
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:20px;
      padding: 2rem;
    }
    @media(max-width:768px){
      .ecat-grid{grid-template-columns:1fr}
      .ecat-grid, .ecat-full { padding: 15px; }
    }

    .ecat-left .ecat-hero{
      width:100%; aspect-ratio:16/9; background:#fff;
      border:1px solid #eee; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      overflow: hidden;
    }
    .ecat-left img{
      width:100%; 
      height: 100%;
      object-fit:contain
    }

    .ecat-section{margin:15px 0}
    .ecat-title{font-size:22px; font-weight:800; color:#004b9b; margin-bottom:15px}
    .ecat-versions{display:grid; gap:8px}
    .ecat-version{border:1px solid #ddd; border-radius:8px; padding:10px; display:flex; justify-content:space-between}
    .ecat-price{color:#004b9b; font-weight:800}

    .ecat-color-row{display:flex;flex-wrap:wrap;gap:8px}
    
    .ecat-specs {
      margin: 15px 0;
      display: grid;
      gap: 10px;
    }
    .ecat-spec-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ecat-spec-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #374151;
    }
    .ecat-spec-value {
      font-weight: 600;
      color: #111827;
      font-size: 14px;
    }
    .ecat-spec-label i {
      color: #004b9b;
    }


    .ecat-cta {
      margin-top: 1rem;
    }

    .ecat-cta-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .ecat-cta-row a {
      flex: 1; /* mỗi nút chiếm 50% */
      text-align: center;
    }

    #ecatContact {
      width: 100%; /* nút dài full */
      display: block;
      text-align: center;
    }

    .btn-primary{background:#004b9b;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;border:2px solid #004b9b;color:#004b9b;padding:9px 16px;border-radius:8px;font-weight:700;cursor:pointer;text-decoration:none}

    .ecat-full{margin-top:30px}

    .ecat-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      margin: 3px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    .ecat-color {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 6px;
      border: 1px solid #ccc;
      border-radius: 50%;
    }

    /* Similar cars in popup */
    #similar-cars {
      display: grid;
      grid-template-columns: repeat(4, 1fr); 
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 1200px) {
      #similar-cars {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      #similar-cars {
        grid-template-columns: 1fr; 
      }
    }

    #similar-cars .product-card,
    #similar-cars .car-card {
      width: 100%;       
      display: block;    
      box-sizing: border-box;
    }

    /* MODIFIED TABS STYLES */
    .ecat-tabs {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .ecat-tab-link {
        padding: 12px 20px;
        cursor: pointer;
        border: none;
        background-color: #f8f9fa;
        font-size: 16px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s ease-in-out;
        text-align: center;
        border-right: 1px solid #ddd;
    }
    .ecat-tab-link:last-child {
      border-right: none;
    }
    .ecat-tab-link:hover {
      background-color: #e9ecef;
    }
    .ecat-tab-link.active {
        background-color: #004b9b;
        color: #fff;
    }
    .ecat-tab-pane {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
    }
    .ecat-tab-pane.active {
        display: block;
    }
     #tab-gallery { /* Remove padding for collage */
        padding: 0;
        border: none;
    }

    .ecat-review-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    .ecat-review-item {
        aspect-ratio: 16/9;
        background: #e9ecef;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        padding: 1rem;
        text-align: center;
    }
    .ecat-review-item i {
        font-size: 48px;
    }
    .ecat-features-list h4 {
        font-size: 18px;
        color: #333;
        margin-top: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    .ecat-features-list p {
        font-size: 15px;
        color: #666;
        line-height: 1.6;
    }
    #ecatTabsSection {
      padding: 20px;
    }

    /* NEW/MODIFIED GALLERY STYLES */
    .ecat-gallery-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }
    .ecat-gallery-item {
        aspect-ratio: 1 / 1;
        border-radius: 8px;
        overflow: hidden;
    }
    .ecat-gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    .ecat-gallery-item:hover img {
        transform: scale(1.05);
    }
    .ecat-gallery-item.hidden {
        display: none;
    }
    @media (max-width: 992px) {
        .ecat-gallery-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    @media (max-width: 768px) {
        .ecat-gallery-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    #ecatLoadMoreBtn {
        display: block;
        margin: 20px auto 0;
        padding: 10px 25px;
        font-size: 16px;
        font-weight: 600;
        background-color: #fff;
        color: #004b9b;
        border: 2px solid #004b9b;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    #ecatLoadMoreBtn:hover {
        background-color: #004b9b;
        color: #fff;
    }
    #ecatLoadMoreBtn.hidden {
        display: none;
    }

    .ecat-menu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.15);
      z-index: 1000;
    }
    .ecat-menu ul {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 0;
      padding: 10px 0;
      list-style: none;
    }
    .ecat-menu a {
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      padding: 6px 10px;
      transition: all .2s;
    }
    .ecat-menu a:hover {
      background: #004b9b;
      border-radius: 6px;
    }

    /* === NEW: Styles for 360 Viewer === */
    .ecat-left-360 { display: none; /* hidden by default */ }
    .car360-container { 
      width: 100%; 
      aspect-ratio: 16/9; 
      background:#fff; 
      border:1px solid #eee; 
      border-radius:12px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      overflow: hidden; 
      margin-bottom: 15px; 
    }
    .cloudimage-360 {
        width: 100%;
        height: 100%;
    }
    .ecat-color-options { text-align: center; }
    .ecat-color-options label {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      margin: 5px;
      border-radius: 20px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
      background: #f5f5f5;
      transition: all 0.2s;
    }
    .ecat-color-options input { display: none; }
    .ecat-color-options input:checked + span {
      border-color: #004b9b;
      font-weight: bold;
      background: #e6f0ff;
      color: #004b9b;
    }
    .ecat-color-sample {
      display: inline-block;
      width: 16px; height: 16px;
      border-radius: 50%; margin-right: 8px;
      vertical-align: middle;
      border: 1px solid #999;
    }
  </style>

  <!-- ====== E-CATALOG POPUP DETAIL ====== -->
<div id="ecatModal" class="ecat-mask" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="ecat-panel" role="document">
    <button class="ecat-x" id="ecatClose" aria-label="Đóng">✕</button>

    <!-- MENU POPUP -->
    <nav class="ecat-menu">
      <ul>
        <li><a href="#ecatIntro">Giới thiệu</a></li>
        <li><a href="#ecatVersions">Chọn phiên bản</a></li>
        <li><a href="#tab-features">Tính năng nổi bật</a></li>
        <li><a href="#tab-gallery">Thư viện</a></li>
        <li><a href="#tab-reviews">Review</a></li>
        <li><a href="#ecatRelated">Xe đề xuất</a></li>
      </ul>
    </nav>

    <div id="ecatVideoHero" class="ecat-video-hero"></div>

    <!-- MAIN GRID -->
    <div class="ecat-grid">
      <!-- LEFT - Modified for 360 view -->
      <div class="ecat-left">
        <!-- Default static image view -->
        <div id="ecat-left-default">
            <div class="ecat-hero"><img id="ecatImg" alt="Hình ảnh xe"></div>
            <div class="ecat-section">
              <h4>Màu ngoại thất</h4>
              <div id="ecatExterior" class="ecat-color-row"></div>
            </div>
            <div class="ecat-section">
              <h4>Màu nội thất</h4>
              <div id="ecatInterior" class="ecat-color-row"></div>
            </div>
        </div>

        <!-- 360 viewer -->
        <div id="ecat-left-360" class="ecat-left-360">
            <div class="car360-container" id="ecatCar360Container"></div>
            <div class="ecat-section">
              <h4>Màu ngoại thất</h4>
              <div class="ecat-color-options" id="ecat-color-options-360"></div>
            </div>
        </div>
      </div>

      <!-- RIGHT - REMAINS UNCHANGED -->
      <div class="ecat-right">
        <h2 id="ecatTitle" class="ecat-title">Tên xe</h2>
        <div class="ecat-section">
          <h4>Phiên bản & Giá bán</h4>
          <div id="ecatVersions" class="ecat-versions"></div>
        </div>
        <div class="ecat-specs">
          <div class="ecat-spec-row">
            <div class="ecat-spec-label"><i class="fa-solid fa-car-side"></i> Kiểu dáng</div>
            <div class="ecat-spec-value" id="ecatStyle">Hatchback</div>
          </div>
          <div class="ecat-spec-row">
            <div class="ecat-spec-label"><i class="fa-solid fa-users"></i> Số chỗ</div>
            <div class="ecat-spec-value" id="ecatSeats">5 chỗ</div>
          </div>
          <div class="ecat-spec-row">
            <div class="ecat-spec-label"><i class="fa-solid fa-gas-pump"></i> Nhiên liệu</div>
            <div class="ecat-spec-value" id="ecatFuel">Xăng</div>
          </div>
        </div>

        <div class="ecat-cta">
          <div class="ecat-cta-row">
            <a id="ecatBrochure" class="btn-outline" target="_blank">Tải brochure</a>
            <a id="ecatWebsite" class="btn-outline" target="_blank">Xem chi tiết website</a>
          </div>
          <button id="ecatContact" class="btn-primary">Liên hệ tư vấn</button>
        </div>
      </div>
    </div>

    <!-- FULL WIDTH SECTIONS -->
    <div class="ecat-full">

      <!-- NEW: Tab Section -->
      <div id="ecatTabsSection" class="ecat-section">
        <div class="ecat-tabs">
            <button class="ecat-tab-link active" data-tab="tab-gallery">Thư viện hình ảnh</button>
            <button class="ecat-tab-link" data-tab="tab-features">Tính năng nổi bật</button>
            <button class="ecat-tab-link" data-tab="tab-reviews">Review sản phẩm</button>
        </div>
        <div class="ecat-tab-content">
            <div id="tab-gallery" class="ecat-tab-pane active">
                 <div id="ecatGalleryGrid" class="ecat-gallery-grid">
                    <!-- JS will populate this -->
                </div>
                <button id="ecatLoadMoreBtn" class="hidden">Xem thêm</button>
            </div>
            <div id="tab-features" class="ecat-tab-pane">
                <div class="ecat-features-list">
                    <h4>Thiết kế KODO sống động</h4>
                    <p>Ngôn ngữ thiết kế KODO thế hệ mới mang lại cảm giác chuyển động liên tục, ngay cả khi xe đứng yên. Các đường nét được vuốt sắc sảo, tạo nên vẻ ngoài thể thao và đầy cuốn hút.</p>
                    
                    <h4>Nội thất sang trọng & tiện nghi</h4>
                    <p>Không gian nội thất được chế tác tinh xảo từ các vật liệu cao cấp, tập trung vào người lái. Màn hình giải trí trung tâm, hệ thống âm thanh vòm và ghế ngồi bọc da mang lại trải nghiệm đẳng cấp.</p>

                    <h4>Công nghệ an toàn i-Activsense</h4>
                    <p>Gói công nghệ an toàn chủ động tiên tiến giúp bạn tự tin làm chủ mọi hành trình, bao gồm các tính năng như cảnh báo điểm mù, cảnh báo phương tiện cắt ngang khi lùi, và hệ thống kiểm soát hành trình thông minh.</p>
                </div>
            </div>
            <div id="tab-reviews" class="ecat-tab-pane">
                <div class="ecat-review-grid">
                    <div class="ecat-review-item">
                        <i class="fa-brands fa-youtube"></i>
                        <span>Video Review 1</span>
                    </div>
                    <div class="ecat-review-item">
                        <i class="fa-brands fa-youtube"></i>
                         <span>Video Review 2</span>
                    </div>
                    <div class="ecat-review-item">
                        <i class="fa-brands fa-youtube"></i>
                         <span>Video Review 3</span>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div id="ecatRelated" class="ecat-section">
        <h2>Dòng xe tương tự</h2>
        <div id="similar-cars" class="similar-cars"></div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  const slugify = (str) => (str||'')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/đ/g,'d').replace(/Đ/g,'D')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/(^-|-$)/g,'');

  const priceFmt = (n)=> {
    try { return Number(n||0).toLocaleString('vi-VN') + ' ₫'; }
    catch(_) { return n }
  };

  const $modal = document.getElementById('ecatModal');
  const $title = document.getElementById('ecatTitle');
  const $versions = document.getElementById('ecatVersions');
  const $vidHero = document.getElementById('ecatVideoHero');
  const $brochure = document.getElementById('ecatBrochure');
  const $website = document.getElementById('ecatWebsite');
  const $close = document.getElementById('ecatClose');

  // Elements for static image and 360 view
  const $ecatLeftDefault = document.getElementById('ecat-left-default');
  const $ecatLeft360 = document.getElementById('ecat-left-360');
  const $img = document.getElementById('ecatImg');
  const $ext = document.getElementById('ecatExterior');
  const $int = document.getElementById('ecatInterior');
  const $ecatCar360Container = document.getElementById('ecatCar360Container');
  const $ecatColorOptions360 = document.getElementById('ecat-color-options-360');


  async function getCars() {
    if (window.carsData) return window.carsData;
    try {
      const res = await fetch("cars_1.json");
      window.carsData = await res.json();
      return window.carsData;
    } catch (e) {
      console.error("Không tải được JSON từ API", e);
      return [];
    }
  }

  function colorsHtml(arr){
    if(!arr || !arr.length) return '<span class="ecat-note">Không có dữ liệu</span>';
    return arr.filter(c => c && c.code).map(c => {
      let bg = Array.isArray(c.code)
        ? `linear-gradient(90deg, ${c.code.join(",")})`
        : c.code;
      return `
        <span class="ecat-chip">
          <span class="ecat-color" style="background:${bg};"></span>
          ${c.name || ''}
        </span>
      `;
    }).join('');
  }

  // === NEW: 360 Viewer Logic ===
  function init360Viewer(car) {
    $ecatCar360Container.innerHTML = '';
    $ecatColorOptions360.innerHTML = '';

    const exMap = new Map();
    (car.versions || []).forEach(v => {
      (v.color_exterior || []).forEach(c => {
        if (!exMap.has(c.name)) exMap.set(c.name, c);
      });
    });
    const colors = [...exMap.values()];
    console.log("🎨 Exterior colors:", colors);
    if (colors.length === 0) {
    console.warn("⚠️ Không có màu để load 360.");
    return;
  }

    const toSlug360 = (name) => {
        if (!name) return '';
        let slug = name.replace(/Đ/g, "D").replace(/đ/g, "d");
        return slug.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, "-");
    };

    colors.forEach((color, idx) => {
        const id = "ecat-360-color-" + idx;
        const label = document.createElement("label");
        label.setAttribute("for", id);
        label.innerHTML = `
          <input type="radio" name="ecat-360-color" id="${id}" value="${color.name}" ${idx === 0 ? "checked" : ""}>
          <span>
            <span class="ecat-color-sample" style="background:${color.code}"></span>
            ${color.name}
          </span>
        `;
        $ecatColorOptions360.appendChild(label);
    });

    const loadColor360 = (colorSlug) => {
      console.log("🎯 Load 360 cho màu:", colorSlug);
        $ecatCar360Container.innerHTML = "";
        const viewer = document.createElement("div");
        viewer.className = "cloudimage-360";
        
        // Explicitly generate the full list of image URLs
        const baseUrl = car.url_360.replace(/\[mau\]/g, colorSlug);
        const imageList = [];
        for (let i = 1; i <= 36; i++) {
            imageList.push(`${baseUrl}/${i}.png`);
        }
        console.log("🖼️ Image list:", imageList);
        
        viewer.setAttribute("data-image-list", JSON.stringify(imageList));
        viewer.setAttribute("data-amount-x", "36");
        viewer.setAttribute("data-lazyload", "true");
        viewer.setAttribute("data-spin-reverse", "true");
        $ecatCar360Container.appendChild(viewer);
        
        if (window.CI360) {
          console.log("🔄 CI360.init chạy...");
            // Re-initialize the viewer on the new element
            window.CI360.init(viewer); 
        } else {
      console.error("❌ CI360 chưa load!");
    }
    };

    $ecatColorOptions360.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", e => {
            loadColor360(toSlug360(e.target.value));
        });
    });

    loadColor360(toSlug360(colors[0].name));
  }


  function openModal(car){
    // === NEW: Conditional display logic ===
    console.log("🚗 OPEN MODAL:", car.name, car);
    if (car.url_360) {
      console.log("✅ Có url_360:", car.url_360);
        $ecatLeftDefault.style.display = 'none';
        $ecatLeft360.style.display = 'block';
        init360Viewer(car);
    } else {
      console.log("ℹ️ Không có url_360, dùng ảnh tĩnh.");
        $ecatLeftDefault.style.display = 'block';
        $ecatLeft360.style.display = 'none';
        
        // Original logic for static images
        $img.src = car.img || '';
        $img.alt = car.name || 'Hình ảnh xe';
        const exMap = new Map(), inMap = new Map();
        (car.versions || []).forEach(v => {
          (v.color_exterior || []).forEach(c => { if (!exMap.has(c.code)) exMap.set(c.code, c); });
          (v.color_interior || []).forEach(c => { if (!inMap.has(c.code)) inMap.set(c.code, c); });
        });
        $ext.innerHTML = colorsHtml([...exMap.values()]);
        $int.innerHTML = colorsHtml([...inMap.values()]);
    }
    
    // The rest of the original openModal function
    $title.textContent = car.name || '';
    $versions.innerHTML = (car.versions||[]).map(v => `
      <div class="ecat-version">
        <strong>${v.name}</strong>
        <div class="ecat-price">${priceFmt(v.originalPrice)}</div>
      </div>
    `).join('');

    if(car.brochure){ $brochure.href = car.brochure; $brochure.style.display='inline-block'; }
    else { $brochure.style.display='none'; }

    if(car.website || car.website_url){
      $website.href = car.website || car.website_url;
      $website.style.display='inline-block';
    }
    else { $website.style.display='none'; }

    document.getElementById('ecatStyle').textContent = car.type || '';
    document.getElementById('ecatSeats').textContent = car.seats ? car.seats.join(', ') + ' chỗ' : '';
    document.getElementById('ecatFuel').textContent = car.fuel ? car.fuel.join(', ') : '';

    // Video Hero Section
    if (car.video) {
      if (car.video.endsWith('.mp4') || car.video.endsWith('.webm') || car.video.endsWith('.ogg')) {
        $vidHero.innerHTML = `<video style="width:100vw; height:100%" src="${car.video}" autoplay muted loop playsinline></video>`;
        $vidHero.style.display = 'block';
      } else {
        const vidId = extractYouTubeId(car.video);
        if (vidId) {
          const embedUrl = `https://www.youtube-nocookie.com/embed/${vidId}?controls=0&autoplay=1&mute=1&loop=1&playlist=${vidId}&showinfo=0&modestbranding=1&fs=0&playsinline=1&autohide=1&rel=0`;
          $vidHero.innerHTML = `<div class="ecat-video"><iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen"></iframe></div>`;
          $vidHero.style.display = 'block';
        } else {
          $vidHero.innerHTML = '';
          $vidHero.style.display = 'none';
        }
      }
    } else {
      $vidHero.innerHTML = '';
      $vidHero.style.display = 'none';
    }



    // Gallery Tab
    const gridContainer = document.getElementById('ecatGalleryGrid');
    const loadMoreBtn = document.getElementById('ecatLoadMoreBtn');
    const INITIAL_VISIBLE_IMAGES = 20;
    const gallery = car.gallery || [];

    if (gallery.length > 0) {
        gridContainer.innerHTML = gallery.map((id, index) => `
            <div class="ecat-gallery-item ${index >= INITIAL_VISIBLE_IMAGES ? 'hidden' : ''}">
                <a href="https://lh3.googleusercontent.com/d/${id}=w1920?authuser=0" target="_blank" rel="noopener noreferrer">
                    <img src="https://lh3.googleusercontent.com/d/${id}=w400?authuser=0" loading="lazy" alt="Gallery image for ${car.name}">
                </a>
            </div>
        `).join('');

        if (gallery.length > INITIAL_VISIBLE_IMAGES) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
    } else {
        gridContainer.innerHTML = '<p class="ecat-note" style="grid-column: 1 / -1; text-align:center; padding: 2rem;">Chưa có hình ảnh</p>';
        loadMoreBtn.classList.add('hidden');
    }
    
    // Reset to the first tab
    document.querySelectorAll('.ecat-tab-link').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.ecat-tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelector('.ecat-tab-link[data-tab="tab-gallery"]').classList.add('active');
    document.getElementById('tab-gallery').classList.add('active');


    // Show modal
    $modal.classList.add('ecat-open');
    $modal.setAttribute('aria-hidden','false');

    // Update URL
    const u = new URL(window.location.href);
    u.searchParams.set('id', slugify(car.name));
    history.replaceState({}, '', u);

    const panel = document.querySelector(".ecat-panel");
    if (panel) panel.scrollTo({ top: 0, behavior: "smooth" });

    // Render similar cars
    renderRecommendedCarsFlat(car.name, window.carsData, "similar-cars");
    document.body.style.overflow = "hidden";

  }

  function closeModal(){
    $modal.classList.remove('ecat-open');
    $modal.setAttribute('aria-hidden','true');
    const u = new URL(window.location.href);
    u.searchParams.delete('id');
    history.replaceState({}, '', u);
    document.body.style.overflow = "";
    // Stop video playback and 360 viewer
    $vidHero.innerHTML = '';
    $ecatCar360Container.innerHTML = '';
  }

  function extractYouTubeId(url){
    try {
      let u = new URL(url);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if(u.searchParams.get('v')) return u.searchParams.get('v');
      let m = u.pathname.match(/\/embed\/([^/?]+)/);
      return m ? m[1] : null;
    } catch(e){ return null; }
  }
  
  // Tab switching logic
  const tabContainer = document.querySelector('#ecatTabsSection .ecat-tabs');
  if(tabContainer){
      tabContainer.addEventListener('click', (e) => {
          if (e.target.matches('.ecat-tab-link')) {
              const tabId = e.target.dataset.tab;
              document.querySelectorAll('#ecatTabsSection .ecat-tab-link').forEach(tab => tab.classList.remove('active'));
              document.querySelectorAll('#ecatTabsSection .ecat-tab-pane').forEach(pane => pane.classList.remove('active'));
              e.target.classList.add('active');
              document.getElementById(tabId).classList.add('active');
          }
      });
  }

  // Load More Button Logic
  const loadMoreBtn = document.getElementById('ecatLoadMoreBtn');
  if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
          const hiddenItems = document.querySelectorAll('#ecatGalleryGrid .ecat-gallery-item.hidden');
          hiddenItems.forEach(item => {
              item.classList.remove('hidden');
          });
          loadMoreBtn.classList.add('hidden');
      });
  }


  $close.addEventListener('click', closeModal);
  $modal.addEventListener('click', (e)=>{ if(e.target === $modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && $modal.classList.contains('ecat-open')) closeModal(); });

  window.CarPopupDetail = {
    openBySlug: async (slug) => {
      const cars = await getCars();
      const car = cars.find(c => slugify(c.name) === slug);
      if(car) openModal(car);
    },
    openByName: async (name) => {
      const cars = await getCars();
      const car = cars.find(c => c.name === name);
      if(car) openModal(car);
    }
  };

  document.addEventListener("click", async (e) => {
    const a = e.target.closest("a[data-slug]");
    if (!a) return;
    e.preventDefault();
    const slug = a.dataset.slug;
    const cars = await getCars();
    const hit = cars.find(c => slugify(c.name) === slug);
    if (hit) openModal(hit);
  });

  window.addEventListener('DOMContentLoaded', async ()=>{
    const id = new URL(window.location.href).searchParams.get('id');
    if(id){ window.CarPopupDetail.openBySlug(id); }
  });
})();

// ====== RECOMMENDATION LOGIC 3 TẦNG ======
function getSimilarCarsTiered(carName, carsData) {
  const currentCar = carsData.find(
    c => c.name.toLowerCase() === carName.toLowerCase()
  );
  if (!currentCar) {
    return { perfectMatch: [], goodAlternative: [], stretchOptions: [] };
  }

  // Luôn dùng originalPrice
  const prices = currentCar.versions.map(v => v.originalPrice);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);

  // Chuẩn hóa type
  const currentType = normalizeType(currentCar.type);
  const sedanHatch = ["Sedan", "Hatchback"];
  const isSedanHatch = sedanHatch.includes(currentType);

  // Helper: cùng nhóm
  function sameGroup(c) {
    const t = normalizeType(c.type);
    if (isSedanHatch) return sedanHatch.includes(t);
    return t === currentType;
  }

  // Helper: check giá theo factor
  function inPrice(c, factor) {
    const carPrices = c.versions.map(v => v.originalPrice);
    const carMin = Math.min(...carPrices);
    const carMax = Math.max(...carPrices);
    return (
      carMin <= maxPrice * (1 + factor) &&
      carMax >= minPrice * (1 - factor)
    );
  }

  // --- Tầng 1: Perfect Match
  const perfectMatch = carsData.filter(c =>
    c.name !== currentCar.name &&
    sameGroup(c) &&
    JSON.stringify(c.fuel) === JSON.stringify(currentCar.fuel) &&
    inPrice(c, 0.15)
  );

  // --- Tầng 2: Good Alternative
  const goodAlternative = carsData.filter(c => {
    if (c.name === currentCar.name) return false;
    const ct = normalizeType(c.type);
    const samePurpose =
      (isSedanHatch && ["Sedan", "Hatchback", "Crossover"].includes(ct)) ||
      ct === currentType;

    return (
      (samePurpose && inPrice(c, 0.25)) ||
      (sameGroup(c) && inPrice(c, 0.35))
    );
  });

  // --- Tầng 3: Stretch Options
  const stretchOptions = carsData.filter(c => {
    if (c.name === currentCar.name) return false;
    const carPrices = c.versions.map(v => v.originalPrice);
    const carMin = Math.min(...carPrices);
    const carMax = Math.max(...carPrices);

    const upsell = carMin >= maxPrice * 1.3 && carMin <= maxPrice * 1.5;
    const value = carMax <= minPrice * 0.8 && carMax >= minPrice * 0.6;
    const fuelAlt = JSON.stringify(c.fuel) !== JSON.stringify(currentCar.fuel);

    return upsell || value || fuelAlt;
  });

  return { perfectMatch, goodAlternative, stretchOptions };
}


function renderCarCard(car) {
  const slug = slugify(car.name);
  const versions = car.versions || [];
  const minPrice = Math.min(...versions.map(v => v.originalPrice));

  let tags = [];
  if (car.highlight) tags.push("Nổi bật");
  if (car.bestseller) tags.push("Bán chạy");
  if (car.new) tags.push("Xe mới");
  const tagsHTML = tags.length
    ? `<div class="tags">${tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>`
    : "";

  return `
    <div class="product-card ${car.brand} p-3 d-flex flex-column">
      ${tagsHTML}
      <a href="#" data-slug="${slug}" style="text-decoration:none;color:inherit">
        <div class="img-frame">
          <img src="${car.img}" alt="${car.name}"/>
        </div>
      </a>
      <div class="product-info mt-2 d-flex flex-column flex-grow-1">
        <h3>
          <a href="#" data-slug="${slug}" style="text-decoration:none;color:#004b9b">${car.name}</a>
        </h3>
        <div class="price-block">
          <div class="main-price">${formatCurrency(minPrice)}</div>
        </div>
        <div class="btn-group mt-2">
          <a class="btn-estimate" href="#" data-slug="${slug}">Dự toán</a>
          <a class="btn-contact" href="#">Liên hệ</a>
        </div>
      </div>
    </div>
  `;
}

function normalizeType(type) {
  if (!type) return "";
  const t = type.toLowerCase();

  if (t.includes("suv")) return "SUV";
  if (t.includes("sedan")) return "Sedan";
  if (t.includes("hatchback")) return "Hatchback";
  if (t.includes("crossover")) return "Crossover";
  if (t.includes("mpv")) return "MPV";
  if (t.includes("pickup")) return "Pickup";

  return type; // fallback: giữ nguyên
}



function renderSimilarCarsTiered(carName, carsData, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const tiers = getSimilarCarsTiered(carName, carsData);

  function renderBlock(title, cars) {
    if (!cars || cars.length === 0) return "";
    return `
      <div class="similar-block">
        <h3>${title}</h3>
          ${cars.map(renderCarCard).join("")}
      </div>
    `;
  }

  container.innerHTML =
    renderBlock("Perfect Match", tiers.perfectMatch) +
    renderBlock("Good Alternatives", tiers.goodAlternative) +
    renderBlock("Stretch Options", tiers.stretchOptions);

  let total = tiers.perfectMatch.length + tiers.goodAlternative.length + tiers.stretchOptions.length;
  if (total < 3) {
    container.innerHTML += "<p class='ecat-note'>Không tìm thấy đủ gợi ý.</p>";
  }
}

function pickRecommendedCars(carName, carsData) {
  const tiers = getSimilarCarsTiered(carName, carsData);

  // Nối lại theo thứ tự ưu tiên
  let all = [...tiers.perfectMatch, ...tiers.goodAlternative, ...tiers.stretchOptions];

  // Loại trùng tên
  const seen = new Set();
  all = all.filter(c => {
    if (seen.has(c.name)) return false;
    seen.add(c.name);
    return true;
  });

  // Lấy tối đa 4 xe
  return all.slice(0, 4);
}

function renderRecommendedCarsFlat(carName, carsData, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const tiers = getSimilarCarsTiered(carName, carsData);

  // ✅ Log toàn bộ 3 tầng
  console.log("==== ĐỀ XUẤT 3 TẦNG CHO:", carName, "====");
  console.log("Perfect Match:", tiers.perfectMatch.map(c => c.name));
  console.log("Good Alternative:", tiers.goodAlternative.map(c => c.name));
  console.log("Stretch Options:", tiers.stretchOptions.map(c => c.name));
  console.log("=====================================");

  // Sau đó mới pick 4 xe theo thứ tự
  let all = [...tiers.perfectMatch, ...tiers.goodAlternative, ...tiers.stretchOptions];
  const seen = new Set();
  all = all.filter(c => {
    if (seen.has(c.name)) return false;
    seen.add(c.name);
    return true;
  });

  const cars = all.slice(0, 4);

  if (cars.length === 0) {
    container.innerHTML = "<p class='ecat-note'>Không tìm thấy xe gợi ý.</p>";
    return;
  }

  container.innerHTML = cars.map(renderCarCard).join("");
}
</script>
<!-- ====== /E-CATALOG POPUP DETAIL ====== -->



<!-- Standby Video -->
<div id="standbyVideo" style="
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:10000;
">
  <video id="standbyPlayer" src="https://newcarnival.kiavietnam.com.vn/storage/video/clip-suv-new-carnival-1.mp4"
    autoplay muted loop playsinline
    style="width:100%;height:100%;object-fit:cover">
  </video>
</div>

<script>
// (function(){
//   const standby = document.getElementById("standbyVideo");
//   const video = document.getElementById("standbyPlayer");
//   let idleTimer;

//   function showStandby(){
//     standby.style.display = "block";
//     video.play();
//   }

//   function hideStandby(){
//     standby.style.display = "none";
//     video.pause();
//     video.currentTime = 0; // reset về đầu
//   }

//   function resetIdle(){
//     clearTimeout(idleTimer);
//     if(standby.style.display === "block"){
//       hideStandby();
//     }
//     idleTimer = setTimeout(showStandby, 5000); // 5s không thao tác thì show
//   }

//   // Các sự kiện người dùng
//   ["mousemove","mousedown","keypress","touchstart","scroll"].forEach(evt=>{
//     document.addEventListener(evt, resetIdle, false);
//   });

//   resetIdle(); // khởi động
// })();
</script>
</body>
</html>

