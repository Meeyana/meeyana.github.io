<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>S·ªï tay t·ª´ v·ª±ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body.dark-mode {
  background-color: #121212 !important;
  color: #e0e0e0 !important;
}

body.dark-mode .card,
body.dark-mode .list-group-item,
body.dark-mode .modal-content {
  background-color: #1e1e1e !important;
  color: #e0e0e0 !important;
  border: 1px solid #333 !important;
}

body.dark-mode .nav-tabs .nav-link.active {
  background-color: #4CAF50 !important;
  color: #fff !important;
  border-color: #4CAF50 !important;
}

body.dark-mode .nav-tabs .nav-link {
  color: #bbb !important;
}

body.dark-mode h4,
body.dark-mode h5,
body.dark-mode .modal-title {
  color: #4CAF50 !important;
}

body.dark-mode .badge {
  background-color: #64B5F6 !important;
  color: #000 !important;
}

body.dark-mode .btn-outline-secondary {
  border-color: #64B5F6 !important;
  color: #64B5F6 !important;
}

body.dark-mode .btn-outline-secondary:hover {
  background-color: #64B5F6 !important;
  color: #000 !important;
}

    #suggestBox { z-index: 1000; }
  </style>
</head>
<body class="bg-light">

<div class="container py-1">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 id="titleBox">üìñ S·ªï tay ƒë√£ c√≥ ... t·ª´</h2>
    <button id="darkToggle" class="btn btn-sm btn-outline-secondary">üåì Dark Mode</button>
  </div>

  <!-- Search -->
  <div class="input-group mb-3">
    <span class="input-group-text bg-white">üîç</span>
    <input type="text" id="searchInput" class="form-control" placeholder="G√µ t·ª´ b·∫°n mu·ªën tra c·ª©u">
  </div>
  <div id="suggestBox" class="list-group position-absolute w-50"
       style="display:none; max-height:200px; overflow-y:auto;"></div>

  <!-- Chart -->
  <div class="row mb-4">
    <div class="col-12 col-md-6 mx-auto">
      <div class="card">
        <div class="card-body">
          <canvas id="learnChart" style="max-height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div id="levelBox">
    <ul class="nav nav-tabs mb-3" id="levelTabs">
      <li class="nav-item"><button class="nav-link active" data-level="1">M·ª©c 1</button></li>
      <li class="nav-item"><button class="nav-link" data-level="2">M·ª©c 2</button></li>
      <li class="nav-item"><button class="nav-link" data-level="3">M·ª©c 3</button></li>
      <li class="nav-item"><button class="nav-link" data-level="4">M·ª©c 4</button></li>
      <li class="nav-item"><button class="nav-link" data-level="5">M·ª©c 5</button></li>
    </ul>
    <div id="wordList" class="list-group"></div>
  </div>
</div>

<!-- Modal chi ti·∫øt -->
<div class="modal fade" id="wordModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi ti·∫øt t·ª´ v·ª±ng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalContent"></div>
    </div>
  </div>
</div>

<script>
const apiUrl = "https://docs.google.com/spreadsheets/d/1TWtEIzObve8g9FnsRiFQeAiwI5viw---CArhmpofnzY/gviz/tq?sheet=JSON&tqx=out:html&tq=SELECT%20B%20where%20A%20=%20%22english%22"; 
let vocabData = [];
let chart;
let activeLevel = 1;

async function loadData() {
  const res = await fetch(apiUrl);
  vocabData = await res.json();

  vocabData = vocabData.map(item => {
    item.learnscale = item.learnscale && item.learnscale.toString().trim() !== "" ? Number(item.learnscale) : 1;
    return item;
  });

  document.getElementById("titleBox").innerText = `üìñ S·ªï tay ƒë√£ c√≥ ${vocabData.length} t·ª´`;

  renderChart();
  renderList(activeLevel);
}

// Chart
function renderChart() {
  const counts = [0,0,0,0,0];
  vocabData.forEach(item => {
    const lvl = Math.min(5, Math.max(1, item.learnscale));
    counts[lvl-1]++;
  });

  const ctx = document.getElementById('learnChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['M·ª©c 1','M·ª©c 2','M·ª©c 3','M·ª©c 4','M·ª©c 5'],
      datasets: [{
        label: 'S·ªë t·ª´',
        data: counts,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: { responsive: true, plugins:{legend:{display:false}} }
  });
}

// Render list theo level
function renderList(level) {
  activeLevel = level;
  const listBox = document.getElementById("wordList");
  const filtered = vocabData.filter(item => item.learnscale == level);

  if (filtered.length === 0) {
    listBox.innerHTML = `<p class="text-muted">Kh√¥ng c√≥ t·ª´ n√†o.</p>`;
    return;
  }

  listBox.innerHTML = filtered.map(item => `
    <button class="list-group-item list-group-item-action" onclick="showDetail(${vocabData.indexOf(item)})">
      <b>${item.vocabulary}</b> <span class="badge bg-info">${item.type || ""}</span>
    </button>
  `).join("");
}

// Modal chi ti·∫øt
function showDetail(index) {
  const item = vocabData[index];
  let examples = "";
  if (item.examples) {
    if (Array.isArray(item.examples)) {
      examples = item.examples.map(e => `<li>${e}</li>`).join("");
    } else {
      examples = item.examples.split(";").map(e => `<li>${e.trim()}</li>`).join("");
    }
  }

  document.getElementById("modalContent").innerHTML = `
    <h4 class="text-success">${item.vocabulary}</h4>
    <p><b>Type:</b> ${item.type || ""}</p>
    <p><b>Meaning:</b> ${item.meaning || ""}</p>
    <p><b>Synonyms:</b> ${Array.isArray(item.synonyms) ? item.synonyms.join(", ") : item.synonyms || ""}</p>
    <p><b>Antonyms:</b> ${Array.isArray(item.antonyms) ? item.antonyms.join(", ") : item.antonyms || ""}</p>
    <h5>Examples:</h5><ul>${examples}</ul>
    <p><b>Common use:</b> ${item.level || "?"}/5</p>
  `;
  new bootstrap.Modal(document.getElementById('wordModal')).show();
}

// Tab event
document.querySelectorAll("#levelTabs button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#levelTabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderList(Number(btn.dataset.level));
  });
});

// Search + Suggestion (popup only)
const searchInput = document.getElementById("searchInput");
const suggestBox = document.getElementById("suggestBox");

searchInput.addEventListener("input", e => {
  const keyword = e.target.value.trim().toLowerCase();

  if (keyword.length >= 2) {
    const suggestions = vocabData.filter(item =>
      item.vocabulary.toLowerCase().includes(keyword)
    ).slice(0, 10);

    if (suggestions.length > 0) {
      suggestBox.style.display = "block";
      suggestBox.innerHTML = suggestions.map(item => `
        <button class="list-group-item list-group-item-action" onclick="selectSuggestion(${vocabData.indexOf(item)})">
          ${item.vocabulary}
        </button>
      `).join("");
    } else {
      suggestBox.style.display = "none";
    }
  } else {
    suggestBox.style.display = "none";
  }
});

function selectSuggestion(index) {
  suggestBox.style.display = "none";
  showDetail(index);
}

// Dark mode toggle + localStorage
const darkToggle = document.getElementById("darkToggle");
function applyDarkMode(state) {
  if (state) {
    document.body.classList.add("dark-mode");
    localStorage.setItem("darkMode", "true");
  } else {
    document.body.classList.remove("dark-mode");
    localStorage.setItem("darkMode", "false");
  }
}
darkToggle.addEventListener("click", () => {
  const isDark = !document.body.classList.contains("dark-mode");
  applyDarkMode(isDark);
  updateChartColors(isDark);
});

// khi load l·∫°i tr·∫°ng th√°i
if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark-mode");
  updateChartColors(true);
}

function updateChartColors(isDark) {
  if (!chart) return;
  if (isDark) {
    chart.data.datasets[0].backgroundColor = 'rgba(100, 181, 246, 0.8)'; // xanh d∆∞∆°ng s√°ng
    chart.options.scales.x.ticks.color = "#eee";
    chart.options.scales.y.ticks.color = "#eee";
    chart.options.scales.x.grid.color = "#333";
    chart.options.scales.y.grid.color = "#333";
  } else {
    chart.data.datasets[0].backgroundColor = 'rgba(54, 162, 235, 0.6)';
    chart.options.scales.x.ticks.color = "#000";
    chart.options.scales.y.ticks.color = "#000";
    chart.options.scales.x.grid.color = "#ccc";
    chart.options.scales.y.grid.color = "#ccc";
  }
  chart.update();
}


loadData();
</script>
</body>
</html>
