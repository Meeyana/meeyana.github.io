<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Sổ tay từ vựng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body.dark-mode {
  background-color: #121212 !important;
  color: #e0e0e0 !important;
}

body.dark-mode .card,
body.dark-mode .list-group-item,
body.dark-mode .modal-content {
  background-color: #1e1e1e !important;
  color: #e0e0e0 !important;
  border: 1px solid #333 !important;
}

body.dark-mode .nav-tabs .nav-link.active {
  background-color: #4CAF50 !important;
  color: #fff !important;
  border-color: #4CAF50 !important;
}

body.dark-mode .nav-tabs .nav-link {
  color: #bbb !important;
}

body.dark-mode h4,
body.dark-mode h5,
body.dark-mode .modal-title {
  color: #4CAF50 !important;
}

body.dark-mode .badge {
  background-color: #64B5F6 !important;
  color: #000 !important;
}

body.dark-mode .btn-outline-secondary {
  border-color: #64B5F6 !important;
  color: #64B5F6 !important;
}

body.dark-mode .btn-outline-secondary:hover {
  background-color: #64B5F6 !important;
  color: #000 !important;
}

    #suggestBox { z-index: 1000; }
  </style>
</head>
<body class="bg-light">

<div class="container py-1">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 id="titleBox">📖 Sổ tay đã có ... từ</h2>
    <div>
      <button id="quizBtn" class="btn btn-sm btn-success">🎯 Làm Quiz</button>
      <button id="darkToggle" class="btn btn-sm btn-outline-secondary">🌓 Dark Mode</button>
    </div>
  </div>

  <!-- Search -->
  <div class="input-group mb-3">
    <span class="input-group-text bg-white">🔍</span>
    <input type="text" id="searchInput" class="form-control" placeholder="Gõ từ bạn muốn tra cứu">
  </div>
  <div id="suggestBox" class="list-group position-absolute w-50"
       style="display:none; max-height:200px; overflow-y:auto;"></div>

  <!-- Chart -->
  <div class="row mb-4">
    <div class="col-12 col-md-6 mx-auto">
      <div class="card">
        <div class="card-body">
          <canvas id="learnChart" style="max-height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div id="levelBox">
    <ul class="nav nav-tabs mb-3" id="levelTabs">
      <li class="nav-item"><button class="nav-link active" data-level="1">Mức 1</button></li>
      <li class="nav-item"><button class="nav-link" data-level="2">Mức 2</button></li>
      <li class="nav-item"><button class="nav-link" data-level="3">Mức 3</button></li>
      <li class="nav-item"><button class="nav-link" data-level="4">Mức 4</button></li>
      <li class="nav-item"><button class="nav-link" data-level="5">Mức 5</button></li>
    </ul>
    <div id="wordList" class="list-group"></div>
  </div>
</div>

<!-- Modal chi tiết -->
<div class="modal fade" id="wordModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết từ vựng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalContent"></div>
    </div>
  </div>
</div>

<!-- Quiz Section -->
<div class="container my-5" id="quizSection" style="display:none;">
  <h3 class="mb-4">🎯 Bài kiểm tra từ vựng</h3>
  <div id="quizBox" class="bg-white text-dark p-4 rounded shadow-sm"></div>
  <button class="btn btn-primary mt-3" id="submitQuiz" style="display:none;">Nộp bài</button>
  <div id="quizResult" class="mt-4"></div>
</div>


<script>
const apiUrl = "https://docs.google.com/spreadsheets/d/1TWtEIzObve8g9FnsRiFQeAiwI5viw---CArhmpofnzY/gviz/tq?sheet=JSON&tqx=out:json&tq=SELECT%20B%20OFFSET%201";
let vocabData = [];
let chart;
let activeLevel = 1;

async function loadData() {
  try {
    const res = await fetch(apiUrl);
    const text = await res.text();
    const match = text.match(/google.visualization.Query.setResponse\(([\s\S]*)\);/);
    if (!match) return console.error("❌ Không tìm thấy JSON trong GViz response");

    const gvizData = JSON.parse(match[1]);
    const jsonChunks = gvizData.table.rows.map(row => row.c[0]?.v || "");
    
    // Bước này chỉ loại bỏ các Ô TRỐNG HOÀN TOÀN. 
    // Các ô chứa '{"vocabulary":""...}' vẫn được giữ lại.
    const nonEmptyChunks = jsonChunks.filter(chunk => chunk && chunk.trim() !== '');

    const rawJson = `[${nonEmptyChunks.join(',')}]`;
    
    // Tại đây, `rawJson` sẽ chứa tất cả các object, kể cả những object có vocabulary rỗng.
    console.log("1. Dữ liệu THÔ đọc từ Sheet:", rawJson);

    let rawData = JSON.parse(rawJson);

    // =================================================================
    // ===== ĐÂY LÀ BƯỚC LỌC QUAN TRỌNG NHẤT MÀ BẠN CẦN =====
    // Nó tạo ra một mảng MỚI, loại bỏ tất cả các object có `vocabulary` rỗng.
    const filteredData = rawData.filter(item => item.vocabulary && item.vocabulary.trim() !== '');
    // =================================================================

    console.log("2. Dữ liệu SAU KHI LỌC (đã loại bỏ object rỗng):", filteredData);

    // Từ đây, code chỉ làm việc với dữ liệu đã được lọc sạch.
    vocabData = filteredData.map(item => ({
      vocabulary: item.vocabulary || "",
      type: item.type || "",
      meaning: item.meaning || "",
      synonyms: Array.isArray(item.synonyms)
        ? item.synonyms
        : (item.synonyms ? item.synonyms.split(",").map(s => s.trim()) : []),
      antonyms: Array.isArray(item.antonyms)
        ? item.antonyms
        : (item.antonyms ? item.antonyms.split(",").map(s => s.trim()) : []),
      examples: Array.isArray(item.examples)
        ? item.examples
        : (item.examples ? item.examples.split(";").map(e => e.trim()) : []),
      learnscale: item.learnscale ? Number(item.learnscale) : 1,
      level: item.level || "?"
    }));

    console.log("3. Dữ liệu CUỐI CÙNG (để hiển thị):", vocabData);

    document.getElementById("titleBox").innerText =
      `📖 Sổ tay đã có ${vocabData.length} từ`;

    renderChart();
    renderList(activeLevel);

  } catch (err) {
    console.error("❌ Lỗi loadData:", err);
  }
}

// Chart
function renderChart() {
  const counts = [0,0,0,0,0];
  vocabData.forEach(item => {
    const lvl = Math.min(5, Math.max(1, item.learnscale));
    counts[lvl-1]++;
  });

  const ctx = document.getElementById('learnChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Mức 1','Mức 2','Mức 3','Mức 4','Mức 5'],
      datasets: [{
        label: 'Số từ',
        data: counts,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: { responsive: true, plugins:{legend:{display:false}} }
  });
}

// Render list theo level
function renderList(level) {
  activeLevel = level;
  const listBox = document.getElementById("wordList");
  const filtered = vocabData.filter(item => item.learnscale == level);

  if (filtered.length === 0) {
    listBox.innerHTML = `<p class="text-muted">Không có từ nào.</p>`;
    return;
  }

  listBox.innerHTML = filtered.map(item => `
    <button class="list-group-item list-group-item-action" onclick="showDetail(${vocabData.indexOf(item)})">
      <b>${item.vocabulary}</b> <span class="badge bg-info">${item.type || ""}</span>
    </button>
  `).join("");
}

// Modal chi tiết
function showDetail(index) {
  const item = vocabData[index];
  let examples = "";
  if (item.examples) {
    if (Array.isArray(item.examples)) {
      examples = item.examples.map(e => `<li>${e}</li>`).join("");
    } else {
      examples = item.examples.split(";").map(e => `<li>${e.trim()}</li>`).join("");
    }
  }

  document.getElementById("modalContent").innerHTML = `
    <h4 class="text-success">${item.vocabulary}</h4>
    <p><b>Type:</b> ${item.type || ""}</p>
    <p><b>Meaning:</b> ${item.meaning || ""}</p>
    <p><b>Synonyms:</b> ${Array.isArray(item.synonyms) ? item.synonyms.join(", ") : item.synonyms || ""}</p>
    <p><b>Antonyms:</b> ${Array.isArray(item.antonyms) ? item.antonyms.join(", ") : item.antonyms || ""}</p>
    <h5>Examples:</h5><ul>${examples}</ul>
    <p><b>Common use:</b> ${item.level || "?"}/5</p>
  `;
  new bootstrap.Modal(document.getElementById('wordModal')).show();
}

// Tab event
document.querySelectorAll("#levelTabs button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#levelTabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderList(Number(btn.dataset.level));
  });
});

// Search + Suggestion (popup only)
const searchInput = document.getElementById("searchInput");
const suggestBox = document.getElementById("suggestBox");

searchInput.addEventListener("input", e => {
  const keyword = e.target.value.trim().toLowerCase();

  if (keyword.length >= 3) {
    const suggestions = vocabData.filter(item =>
      item.vocabulary.toLowerCase().includes(keyword)
    ).slice(0, 10);

    if (suggestions.length > 0) {
      suggestBox.style.display = "block";
      suggestBox.innerHTML = suggestions.map(item => `
        <button class="list-group-item list-group-item-action" onclick="selectSuggestion(${vocabData.indexOf(item)})">
          ${item.vocabulary}
        </button>
      `).join("");
    } else {
      suggestBox.style.display = "none";
    }
  } else {
    suggestBox.style.display = "none";
  }
});

function selectSuggestion(index) {
  suggestBox.style.display = "none";
  showDetail(index);
}

// Dark mode toggle + localStorage
const darkToggle = document.getElementById("darkToggle");
function applyDarkMode(state) {
  if (state) {
    document.body.classList.add("dark-mode");
    localStorage.setItem("darkMode", "true");
  } else {
    document.body.classList.remove("dark-mode");
    localStorage.setItem("darkMode", "false");
  }
}
darkToggle.addEventListener("click", () => {
  const isDark = !document.body.classList.contains("dark-mode");
  applyDarkMode(isDark);
  updateChartColors(isDark);
});

// khi load lại trạng thái
if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark-mode");
  updateChartColors(true);
}

function updateChartColors(isDark) {
  if (!chart) return;
  if (isDark) {
    chart.data.datasets[0].backgroundColor = 'rgba(100, 181, 246, 0.8)'; // xanh dương sáng
    chart.options.scales.x.ticks.color = "#eee";
    chart.options.scales.y.ticks.color = "#eee";
    chart.options.scales.x.grid.color = "#333";
    chart.options.scales.y.grid.color = "#333";
  } else {
    chart.data.datasets[0].backgroundColor = 'rgba(54, 162, 235, 0.6)';
    chart.options.scales.x.ticks.color = "#000";
    chart.options.scales.y.ticks.color = "#000";
    chart.options.scales.x.grid.color = "#ccc";
    chart.options.scales.y.grid.color = "#ccc";
  }
  chart.update();
}

// ========================
// 🎯 Quiz Feature
// ========================
const quizBtn = document.getElementById("quizBtn");
const quizSection = document.getElementById("quizSection");
const quizBox = document.getElementById("quizBox");
const submitQuiz = document.getElementById("submitQuiz");
const quizResult = document.getElementById("quizResult");

quizBtn.addEventListener("click", async () => {
  quizSection.style.display = "block";
  quizBox.innerHTML = `<div class='text-center text-muted'><div class='spinner-border text-primary'></div><p>Đang tải câu hỏi...</p></div>`;
  quizResult.innerHTML = "";
  submitQuiz.style.display = "none";

  try {
    const res = await fetch("https://n8n.n8ntuanphangz.xyz/webhook/7ce99e53-cf0a-41a7-b31c-f61bdd1fc532", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({}),
      mode: "no-cors"
    });
    const data = await res.json();
    renderQuiz(data);
  } catch (err) {
    quizBox.innerHTML = `<div class='alert alert-danger'>❌ Lỗi tải câu hỏi: ${err.message}</div>`;
  }
});

let quizData = [];

function renderQuiz(data) {
  quizData = data.quiz || data;
  quizBox.innerHTML = quizData.map(q => `
    <div class="mb-4">
      <p><b>${q.id}. ${q.question}</b></p>
      ${q.options.map(opt => `
        <div>
          <input type="radio" name="q${q.id}" value="${opt}" id="q${q.id}_${opt}">
          <label for="q${q.id}_${opt}">${opt}</label>
        </div>
      `).join("")}
    </div>
  `).join("");
  submitQuiz.style.display = "inline-block";
}

// Nộp bài
submitQuiz.addEventListener("click", () => {
  const answers = [];
  quizData.forEach(q => {
    const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
    answers.push({
      vocabulary: q.vocabulary,
      questionId: q.id,
      answer: selected ? selected.value : null,
      correct: q.correct
    });
  });

  const correctCount = answers.filter(a => a.answer === a.correct).length;
  quizResult.innerHTML = `
    <div class="alert alert-info">
      ✅ Bạn trả lời đúng <b>${correctCount}</b> / ${answers.length} câu.
    </div>
  `;

  // Gửi kết quả về n8n (nếu sau này cần update Learnscale)
  fetch("https://n8n.n8ntuanphangz.xyz/webhook-test/eng-quiz-submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ answers })
  });
});



loadData();
</script>
</body>
</html>
